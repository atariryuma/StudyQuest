# StudyQuest

> 小中学校向けゲーミフィケーション型課題管理・学習支援ウェブアプリ

## 1. プロジェクト概要

**StudyQuest** は、Google Workspace を活用し、小中学校の生徒向けにゲーミフィケーション要素を取り入れた課題管理・学習支援を実現するWebアプリです。**単一のスプレッドシート**をデータベースとして利用することで、シンプルで管理しやすく、リアルタイムなデータ反映を実現しています。

-   **教師側**: 課題の作成・配信、全生徒の進捗をリアルタイムに分析できる管理パネルを提供。
-   **生徒側**: XPやレベル、トロフィーでモチベーションを可視化し、課題への挑戦を促すクエストボードを提供。
-   **AIフィードバック**: Gemini APIと連携し、生徒が課題で行き詰まった際にヒントを提示します。

## 2. データ構造：シンプル・一元管理モデル

本プロジェクトは、**単一のスプレッドシート** `StudyQuest_DB` に全てのデータを集約する、シンプルで効率的な設計を採用しています。これにより、複雑なファイル操作やデータ同期処理を必要としません。

### フォルダ構成

```
StudyQuest_<TeacherCode>/
└── StudyQuest_DB  (このファイルに全データを集約)
```

### スプレッドシート (`StudyQuest_DB`) の構成

| シート名 | 役割 |
| :--- | :--- |
| **`Tasks`** | 課題情報を一元管理するマスタシート |
| **`Submissions`** | 全生徒の回答をリアルタイムに記録する中央ログ |
| **`Students`** | 生徒情報（レベル、XPなど）を管理するマスタシート |
| **`Dashboard`** | `QUERY`関数などを活用し、提出状況やランキングを自動で可視化する教師用ダッシュボード |

## 3. 機能要件

### 3.1 教師モード (`manage.html`)

1.  **初期設定**: `initTeacher()` を実行し、必要なデータ管理用スプレッドシート (`StudyQuest_DB`) を自動生成します。
2.  **管理パネル**:
    -   課題作成フォーム (`createTask`)
    -   課題一覧（編集・削除機能付き, `listTasks`, `deleteTask`)
    -   リアルタイム統計ダッシュボードの閲覧

### 3.2 生徒モード (`quest.html`)

1.  **ログイン**: 教師コードと自身の情報を入力し、クエストボードを初期化します。
2.  **クエストボード**:
    -   XPバー、レベル、獲得トロフィーを表示
    -   未回答／完了済みクエストの一覧 (`listTasks`)
    -   回答送信 (`submitAnswer`)、AIフィードバック (`callGeminiAPI_GAS`)

## 4. StudyQuest_DB の詳細

本アプリでは、教師ごとに 1 つの **StudyQuest_DB** スプレッドシートを使用します。
データは次の 4 シートに集約され、複雑なファイル管理を必要としません。

| シート名 | 役割 |
| :--- | :--- |
| `Tasks` | 課題情報を管理 |
| `Submissions` | 生徒からの提出ログ |
| `Students` | 生徒の XP・レベルなどを保持 |
| `Dashboard` | QUERY 関数で集計した統計ビュー |

## 5. セットアップ

1.  **リポジトリをクローン**
    ```bash
    git clone <リポジトリURL>
    cd studyquest
    ```
2.  **Clasp 認証と設定**
    ```bash
    npm install -g @google/clasp
    clasp login
    # .clasp.json に scriptId と rootDir を設定
    ```
3.  **依存インストール**
    ```bash
    npm install
    ```
4.  **(任意) Google Drive API の追加**
    Drive API はフォルダ特定など最小限の操作にのみ利用します。必要に応じて Apps Script エディタの「サービス」から追加してください。

## 6. CI / CD (GitHub Actions)

`.github/workflows/deploy.yml` により、`main`ブランチへのプッシュをトリガーに自動デプロイが実行されます。
（内容は変更なしのため省略）

## 7. 開発ガイドライン

-   **データ操作**: すべてのデータは `SpreadsheetApp` サービスを通じて `StudyQuest_DB` スプレッドシートに直接読み書きします。
-   **データ集計**: `QUERY`などのスプレッドシート関数を最大限に活用し、GAS側での複雑なデータ処理を避けます。
-   **フロントエンド構造**: `include()` を活用し、UIパーツ（ヘッダー、フッターなど）を共通化します。

## 8. Gemini APIキーの管理とアプリケーション設定

### **APIキーの管理 (スクリプトプロパティ)**

Gemini APIキーは、アプリケーション全体で1つを共有します。セキュリティを確保するため、キーはスプレッドシート上ではなく、GASのサーバーサイドに安全に保存される**スクリプトプロパティ (Script Properties)** を使用します。

* 設定画面から入力されたキーは `setGlobalGeminiApiKey` 関数によってスクリプトプロパティに保存されます。
* API利用時には `getGlobalGeminiApiKey` 関数で安全に呼び出されます。
* スクリプトプロパティに保存する際のプロパティ名は `geminiApiKey` です。

## 9. テスト実行

1. 依存インストール
    ```bash
    npm install
    ```
    または Codex 環境では
    ```bash
    scripts/setup-codex.sh
    ```
2. テスト
    ```bash
    npm test
    ```
