# StudyQuest

**要件定義（StudyQuest／Gamified Web App プロジェクト）**

---

## 1. プロジェクト概要

**1.1 プロジェクト名**
StudyQuest（仮称）– 小学校向けゲーミフィケーション型課題管理・学習支援ウェブアプリ

**1.2 背景・目的**

* **背景**

  * 小学校における生徒の課題（クエスト）管理と学習意欲向上のため、ゲーミフィケーション要素を取り入れたWebアプリ導入を検討。
  * 既存のGoogle Workspace（Drive、Spreadsheet、Apps Script）を活用し、低コストかつ柔軟に運用できるシステムを構築。
  * 生徒が自ら進んで課題に取り組み、教師側は進捗と学習履歴を一元管理したい。

* **目的**

  1. **教師側**は「教師コード（6桁英数字）」を取得／入力し、自動生成された専用フォルダ・スプレッドシート上で課題の作成・配信・統計分析が可能。
  2. **生徒側**は教師から共有された「教師コード」と「学年・組・番号」を入力し、自分専用の“クエストボード”画面から未回答クエストを確認し、回答を送信できる。回答ごとにXPが加算され、XPバーやレベル、獲得トロフィーを可視化。
  3. **回答ボード**機能を通じて、他の生徒の取り組みや教師のフィードバック状況をリアルタイムに把握可能。
  4. \*\*Google Apps Script（GAS）\*\*をバックエンド処理として用い、データはGoogle Spreadsheetに保存。Webアプリとして動作する。
  5. \*\*AIフィードバック機能（Gemini API連携）\*\*を実装し、児童の回答に対してゲーム的な演出でヒントや気づきを提供。

---

## 2. ステークホルダー（ユーザー）

1. **教師（管理者）**

   * 初回ログイン時：「kyoushi」を入力 → Google Drive上に`StudyQuest_Teach_<教師コード>`フォルダとスプレッドシートを自動作成。
   * 2回目以降ログイン：教師コードのみで既存フォルダ／スプレッドシートにアクセス。
   * 課題（クエスト）の作成・編集・削除、統計情報の参照、生徒一覧管理、グローバル回答ボードの閲覧などを行う。
   * 生徒としてもクエストボードにアクセスできるように、フォルダ・ファイル名は明確に区別。

2. **生徒（利用者）**

   * ログイン時に教師コード・学年（1～6）・組（英字1文字）・番号（1～99）を入力。
   * 未回答クエストをカード表示で確認し、回答を送信。
   * 同一課題に複数回答した場合もすべて保存され、履歴として参照可能。
   * 回答ごとに「付与XP」「累積XP」「レベル」「獲得トロフィー」を自動計算し、可視化。
   * **AIフィードバック機能を用いて、児童の回答に対しゲーム的に気づきやヒントを得られる。**
   * AIフィードバックは各課題につき2回まで利用可能。課題に回答するチャンスは最大3回。
   * 自身の回答履歴や学習履歴（Study Log）を閲覧可能。

3. **運用担当（管理者レベル）**

   * Google Driveのストレージ管理、フォルダ権限設定、GASのデプロイ・バージョン管理を担当。

---

## 3. 概要機能要件

### 3.1 教師モード（管理パネル：`manage.html`）

#### 3.1.1 ログイン／初期設定

* **入力項目**

  * パスコード（固定：`kyoushi`）

* **入力ルール・バリデーション**

  * パスコード入力欄は半角文字でのみ受け付け、全角入力時は半角に自動変換。
  * 数字入力欄（該当箇所がある場合）は全角数字を自動で半角数字に変換。
  * 教師コード入力欄は入力時に自動で**半角英数字大文字**に変換し、常に大文字で送信。
  * 形式エラーとなるのは、英数字以外の文字列が含まれている場合のみ。

* **処理フロー**

  1. パスコード検証後、`initTeacher(passcode)`を実行。
  2. **初回ログイン**（スクリプトプロパティに教師コードなしの場合）：

     * `generateTeacherCode()`にて6桁英数字のユニークな教師コードを生成。
     * DriveAppで`StudyQuest_Teach_<教師コード>`フォルダを作成。
     * フォルダ内に`StudyQuest_Teach_<教師コード>_Log`という名前のスプレッドシートを作成し、以下のシートを初期化：

       * `📜 目次`
       * `課題一覧`
       * `生徒一覧`
       * `回答ログ（全体ボード用）`
       * `AIフィードバックログ`
       * **生徒個別シート**（`Student_<ID>`）は、生徒が初回ログイン時に動的作成。
     * 生成した教師コードを返却し、初回ログインメッセージを表示。
  3. **2回目以降ログイン**（スクリプトプロパティに教師コードが存在）：

     * 最新の教師コードを取得して返却し、管理パネルに遷移。

* **出力画面**

  * 初回ログイン：教師コードを通知するモーダルを表示。
  * 2回目以降：ダッシュボードに遷移し、「おかえりなさい！」メッセージを表示。

#### 3.1.2 管理パネル（`manage.html`）

* **画面構成**

  * **ヘッダー**

    * 左：StudyQuestロゴ（またはタイトル）
    * 右：

      * 「回答ボードを見る」リンク → `?page=board&teacher=<教師コード>`
      * 教師コード表示（例：`CODE: ABC123`）

        * **クリック時拡大表示**：教師コードを大きくポップアップ表示し、生徒が自分のログイン画面で入力しやすいようにする。
      * 課題数（アイコン＋件数）
      * **生徒数（アイコン＋名）**：現在は累計ログイン回数を表示していたが、**登録されている生徒数**を表示するよう修正する。

        * `生徒一覧`シートの行数から計算し、ヘッダー行を除いた行数を表示。
  * **メインエリア（2カラム）**

    * **左側：新しい課題（クエスト）作成フォーム**

      1. 教科ドロップダウン（国語、算数、理科、社会、英語）
      2. 問題文入力（テキストエリア）
      3. 回答タイプ選択（ラジオボタン）

         * 短文回答 (`short`)
         * 段落回答 (`long`)
         * 選択式 (`radio`)
         * チェックボックス (`checkbox`)
      4. 「選択式/チェックボックス」選択時のみ：選択肢数プルダウン（2～5）

         * 動的に生成された選択肢入力欄が現れる
      5. 自己評価許可チェックボックス
      6. **Gemini API設定**

         * 入力欄：APIキー（またはWebアプリ設定内の選択）
         * **ペルソナ選択**：ドロップダウンで「小学生向け」「中学生向け」「教師向け」など、Geminiに渡すプロンプトテンプレートを切り替え可能。
      7. 作成ボタン
    * **右側：課題一覧（カード表示）**

      * 最新作成順にカードを並べる
      * 各カードには以下を表示：

        * 教科＋問題文（改行あり）
        * 回答タイプ（日本語ラベル）
        * 作成日時
        * 削除ボタン（アイコン）

* **主要なGAS呼び出し**

  * `createTask(teacherCode, payloadAsJson, selfEval, persona)`：課題（JSONデータ）を`課題一覧`シートに新規追加。`persona`情報を含める。
  * `listTasks(teacherCode)` → `renderTasks(rows)`でカード描画。
  * `deleteTask(teacherCode, taskId)` → 削除後、再度`listTasks`と`getStatistics`を呼び出し。
  * `getStatistics(teacherCode)`：生徒数（`生徒一覧`行数）、課題数、各生徒の累積XP/レベル/トロフィーを集計して返却。

* **動作要件**

  * ボタン押下時にGSAPで微細なアニメーションを付与。
  * 課題作成直後にリストをリアルタイム更新。
  * 選択式/チェックボックス選択肢入力欄はラジオボタン切り替え時に動的生成・破棄。
  * カード上の削除ボタンを押すと確認ダイアログを表示し、確定後にAPI呼び出し。

### 3.2 生徒モード（クエストボード：`input.html`）

#### 3.2.1 ログイン／初期設定

* **入力項目**

  * 教師コード（6桁英数字・大文字半角）
  * 学年（文字列 `"1"`～`"6"`：全角数字は自動で半角に変換）
  * 組（文字列 英字1文字：全角アルファベットは自動で半角大文字に変換）
  * 番号（文字列 `"1"`～`"99"`：全角数字→半角数字に変換）

* **入力ルール・バリデーション**

  * 教師コード欄は全角英数字・小文字で入力しても、**自動で半角英数字大文字**に変換。形式エラーは英数字以外を含む場合のみ発生。
  * 学年・番号欄は全角数字を必ず半角数字に変換し、1～6（学年）、1～99（番号）の範囲チェックを行う。
  * 組欄は全角アルファベットを半角アルファベットに変換し、大文字化。1文字入力を必須とする。
  * バリデーションエラー時は、赤文字で「形式が正しくありません」などのメッセージを表示し、再入力を促す。

* **処理フロー**

  1. **クライアント側バリデーション**で各項目が所定の形式か検証。
  2. `initStudent(teacherCode, grade, classroom, number)`を呼び出し：

     * スプレッドシート取得 → `生徒一覧`シートに該当`studentId`が存在しない場合は新規追加。
     * `Student_<studentId>`シートを探し、存在しなければ**必ず作成**。既存シートはそのまま再利用。
     * `Student_<studentId>`シートに、以下のヘッダー列を初期化：

       | 列番号 | フィールド | 説明                      |
       | --- | ----- | ----------------------- |
       | A   | 日時    | 回答送信日時（`Date`）          |
       | B   | 課題ID  | 課題を一意に識別するUUID          |
       | C   | 課題内容  | 回答時点の問題文                |
       | D   | 回答本文  | 生徒が入力した回答               |
       | E   | 付与XP  | 回答により今回獲得したXP（固定20など）   |
       | F   | 累積XP  | 回答後の累積XP                |
       | G   | レベル   | 回答後のレベル                 |
       | H   | トロフィー | 回答により獲得したトロフィー名（カンマ区切り） |
       | I   | 回答回数  | その課題に対する回答回数（1～3）       |
     * 既存シートがある場合はそのまま利用し、**行数を変更せず過去履歴を残す**。
  3. 成功時、`?page=input&teacher=<>&grade=<>&class=<>&number=<>`に遷移。

#### 3.2.2 クエストボード画面（`input.html`）

* **画面構成**

  * **背景**：パーティクルアニメーション（Canvas+2D描画）。
  * **上部**：XPバー＋レベル表示

    * XPバーは全幅100%、現在の累積XPを％で表示。
    * バー下に「レベル：<数値>」をリアルタイム更新。
  * **メインエリア**（PCは左右2カラム、SPは縦並び）

    * **左カラム**

      1. 未回答クエスト一覧（カード表示、背景グラデーション紫→藍）

         * 各カードに：

           * 教科ラベル、課題IDを元に取得した問題文冒頭、作成日時
           * 提出済みの場合は取り消し線表示＆半透明化し、完了済みエリアに移動。
      2. 完了済みクエスト一覧（カード表示）
    * **右カラム：クエスト詳細エリア**

      * 常に右カラムに詳細表示（SPはモーダル表示）。
      * 表示項目：

        1. **課題詳細**：教科名称、問題文全文。
        2. **回答入力欄**（テキストエリア or 選択肢フォーム）。
        3. **送信ボタン**（回答送信）。
        4. **AIフィードバックボタン**（Gemini APIを呼び出し、ヒント・気づきを提供）。
        5. **履歴を見るボタン**。
        6. **AIフィードバック回数表示**：各課題ごとに残り呼び出し回数（最大2回）を表示。
        7. **回答回数制限表示**：各課題の回答は最大3回まで。回数表示と制限情報を明示。
  * **フッター/その他**

    * **デバッグパネル**：画面左下に縮小表示。GAS呼び出しログ（開始/成功/失敗）を時刻付きで表示するテキストエリア。公開時は非表示可能。

* **主要なGAS／API呼び出し**

  1. `listTasks(teacherCode)` → 全課題を取得し、クライアント側で未回答・回答済みを判定。

  2. `getStudentHistory(teacherCode, studentId)` → `Student_<ID>`シートから全履歴行を取得し、配列形式で返却。

  3. **詳細表示時**（タスクカードクリック）

     * クライアント側で返却された履歴行（`historyRows`）をフィルタして、その課題IDの行群を抽出。
     * 最後に追加された回答行の回答内容をテキストエリアにプリフィル。
     * 過去回答も「履歴を見る」から閲覧可能。

  4. **回答送信処理**

     * ボタン押下でクライアントが以下を実行：
       a. **回答回数チェック**：すでに3回回答済みならエラー表示し、送信不可。
       b. **クライアントローカルで計算**：

       * `historyRows`から前回累積XP（列F）、前回レベル（列G）、獲得済みトロフィー（列H）を取得。
       * `earnedXp`を算出（問題ごとに固定スコア）。
       * 新しい`newTotalXp = prevTotalXp + earnedXp`。
       * **レベル判定**：`threshold = prevLevel × 100` → `newTotalXp ≥ threshold`ならレベルアップ。
       * **トロフィー獲得条件**：

         * 例：`newTotalXp ≥ 500`で「初級バッジ」、`newLevel ≥ 5`で「達人トロフィー」。
       * **回答回数インクリメント**：送信前の回数に +1。
         c. **回答保存呼び出し**：
         `submitAnswer(teacherCode, studentId, taskId, answerText, earnedXp, newTotalXp, newLevel, newTrophies, attemptCount)`
         d. **AIフィードバックログ保存**（回答後、回答中に不要）。
         e. **UI更新**：XPバー幅とレベルテキストをGSAPでアニメーション更新。残り回答回数表示を刷新。
         f. 0.5秒後に再度 `listTasks` と `getStudentHistory` を呼び出し、UIを最新化。

  5. **AIフィードバック処理**

     * AIフィードバックボタン押下時（各課題ごと最大2回まで）：
       a. **呼び出し回数チェック**：すでに2回呼び出し済みならボタンを「模範解答表示」に切り替え。
       b. **Gemini API呼び出し**：

       * プロンプト作成：児童の回答内容、課題タイトル、ペルソナ選択（小学生用・中学生用など）に応じたテンプレートを適用。
       * 要求例：『この回答をもとに、次の問いかけのヒントをください。・・・』など。
         c. **GAS経由で取得**：`callGeminiAPI_GAS(prompt, persona)`を呼び出し、非同期取得。
         d. **フィードバック表示**：画面上に型アニメーション（タイプライター）で表示。
         e. **呼び出し回数カウント**：成功時にローカル変数またはHiddenフィールドにカウントを保存。
         f. **呼び出し回数上限到達時**：AIフィードバックボタンを「模範解答を見る」ボタンに切り替え。
         g. **模範解答表示機能**：呼び出し上限到達後は模範解答を表示するのみでAI呼び出し不可。

  6. **履歴表示**（モーダル表示）

     * `historyRows`配列から該当課題IDの行群を抽出し、テーブル形式で以下を表示：
       \| 日時 | 課題ID | 回答本文 | 付与XP | 累積XP | レベル | トロフィー | 回答回数 |

       * 同一課題IDへの複数回答もすべて行として並べる。
     * 各行クリックで詳細表示（必要に応じて）。

---

## 3.3 回答ボード（`board.html`）

* **機能概要**

  * 教師モードの「回答ボードを見る」リンクから遷移。
  * `listBoard(teacherCode)` を呼び出し、`回答ログ（全体ボード用）`シートから直近30件を取得。
  * 返却データの構造：

    ```js
    [  
      { studentId: "6-1-1", timestamp: <Date>, taskId: "uuid-xxx", answerSummary: "□□を…", earnedXp: 20, totalXp: 140, level: 2, trophies: "初級王冠", aiCalls: 1, attempts: 2 },  
      …  
    ]  
    ```
  * カードレイアウトでグリッド表示。各カードには：

    1. 生徒ID
    2. 回答要約／または回答全文
    3. 付与XP
    4. 回答後累積XP
    5. 回答後レベル
    6. 獲得トロフィー（あれば）
    7. **AIフィードバック利用回数**（例：`AIヒント: 1/2`）
    8. **回答回数**（例：`回答: 2/3`）
  * GSAP でカードを順次回転フェードインアニメーション（rotationY: 90→0, opacity: 0→1）。
  * 15秒ごと自動更新（`setInterval`）。

### 3.4 GAS バックエンド全体構成

#### 3.4.1 ファイル構成

* `Code.gs`（サーバーサイド関数全般）
* `appsscript.json`（タイムゾーン：Asia/Tokyo、実行ユーザー：USER\_ACCESSING、アクセス：ANYONE）

#### 3.4.2 主な関数一覧

1. `doGet(e)`

   * パラメータ `page`, `teacher`, `grade`, `class`, `number` を受け取り、対応するHTMLテンプレートを返す。

2. `generateTeacherCode()`

   * 6桁英数字のランダム文字列を生成。スクリプトプロパティに重複がなければ返却。

3. `findLatestFolderByName_(name)`

   * DriveAppから同名フォルダを検索し、最新作成日時のフォルダを返す。

4. `initTeacher(passcode)`

   * 教師モード初回/2回目以降の判定 → フォルダ・スプレッドシートの生成または取得 → 必要シート初期化。

5. `getSpreadsheetByTeacherCode(teacherCode)`

   * スクリプトプロパティからスプレッドシートIDを取得し開く（存在しない場合はnull）。

6. `findStudentSheet_(ss, studentId)`

   * 指定スプレッドシート内で`Student_<studentId>`という名前のシートを検索・正規化して返す。

7. `initStudent(teacherCode, grade, classroom, number)`

   * **生徒初回ログイン処理** → `生徒一覧`シートにID登録 → `Student_<ID>`シート作成または既存シート利用。
   * **Google Driveへの個別フォルダ／ファイル作成**：生徒ログイン時に、生徒のGoogle Drive内に`StudyQuest_Stu_<teacherCode>_<studentId>`フォルダを作成し、個別CSVまたはGoogle Spreadsheetファイルを生成して回答ログのバックアップを保存する。（オプション機能）

8. `createTask(teacherCode, payloadAsJson, selfEval, persona)`

   * `課題一覧`シートに新行追加（課題ID: UUID、JSON文字列、自己評価フラグ、作成日時、ペルソナ）。

9. `listTasks(teacherCode)`

   * `課題一覧`シートから全行取得し、新→旧順の配列で返却。

10. `deleteTask(teacherCode, taskId)`

* `課題一覧`シートから該当IDの行を検索し削除。

11. `submitAnswer(teacherCode, studentId, taskId, answer, earnedXp, newTotalXp, newLevel, trophiesObtained, attemptCount)`

    * **処理詳細**：

      1. `getSpreadsheetByTeacherCode(teacherCode)`でスプレッドシート取得。
      2. `findStudentSheet_(ss, studentId)`で`Student_<ID>`シート取得（存在しなければ異常終了）。
      3. `課題一覧`シートから`taskId`を検索し、JSONをパースして`question`を取得。
      4. `Student_<ID>`シートに新行を追記（列A～Iに日時、課題ID、課題内容、回答本文、付与XP、累積XP、レベル、トロフィー、回答回数）。
      5. `回答ログ（全体ボード用）`シートに新行を追記（列A～Jに日時、生徒ID、課題ID、回答概要、付与XP、累積XP、レベル、トロフィー、AI呼び出し回数、回答回数）。
      6. **生徒Driveへの個別ファイルへも追記（オプション機能）**。
      7. 成功時は`{ status: "ok", newTotalXp: <数値>, newLevel: <数値>, trophies: <文字列または配列> }`を返却。
      8. エラー時は`{ status: "error", message: <エラーメッセージ> }`を返却。

12. `getStudentHistory(teacherCode, studentId)`

    * `Student_<ID>`シートから全行を取得し、各行をオブジェクト化して配列で返却：

      ```js
      [  
        { timestamp: <Date>, taskId: <String>, question: <String>, answer: <String>, earnedXp: <Number>, totalXp: <Number>, level: <Number>, trophies: <String>, attemptCount: <Number> },  
        …  
      ]  
      ```
    * 同一`taskId`への複数回答行もすべて含む（履歴として保持）。

13. `listBoard(teacherCode)`

    * `回答ログ（全体ボード用）`シートから最終30行を取得し、各行をオブジェクト化して返却：

      ```js
      [  
        { studentId: "6-1-1", timestamp: <Date>, taskId: <String>, answerSummary: <String>, earnedXp: <Number>, totalXp: <Number>, level: <Number>, trophies: <String>, aiCalls: <Number>, attempts: <Number> },  
        …  
      ]  
      ```

14. `getStatistics(teacherCode)`

    * **処理詳細**：

      1. `課題一覧`シートの行数（ヘッダー行を除く）を取得 → `taskCount`。
      2. `生徒一覧`シートの行数（ヘッダー行を除く）を取得 → `studentCount`。
      3. **全**`Student_<ID>`シートを走査し、各シートの最終行を取得する（`getLastRow()`）。

         * その行の列F（累積XP）、列G（レベル）、列H（トロフィー）を読み取り、下記情報をまとめる：

           ```js
           stats = [  
             { studentId: "6-1-1", totalXp: 340, level: 3, trophies: "初級王冠, 学年1位" },  
             …  
           ];  
           ```
      4. `{ status: "ok", studentCount: <数値>, taskCount: <数値>, stats: <配列> }`を返却。

15. `callGeminiAPI_GAS(prompt, persona)`

    * **処理内容**：

      * パラメータとして受け取ったプロンプトとペルソナ情報を用いてGemini APIを呼び出し、フィードバック文を取得。
      * レスポンスを返却。

16. `logToSpreadsheet(logData)`

    * **処理内容**：

      * AIフィードバック情報（児童ID、課題ID、回答、フィードバック、スコア、試行回数など）を`AIフィードバックログ`シートに記録。

17. `include(filename)`

    * HTMLテンプレート埋め込み用ヘルパー関数。

---

## 4. データ構造（スプレッドシートシート定義）

### 4.1 スプレッドシート構成概要

* **フォルダ名**： `StudyQuest_Teach_<教師コード>`（教師用管理フォルダ）
* **スプレッドシート名**： `StudyQuest_Teach_<教師コード>_Log`
* **シート一覧**：

  1. `📜 目次`
  2. `課題一覧`
  3. `生徒一覧`
  4. `回答ログ（全体ボード用)`
  5. `AIフィードバックログ`
  6. `Student_<studentId>`（動的作成、生徒数分）

### 4.2 各シート詳細

#### 4.2.1 `📜 目次`

* **列構成**

  | 列番号 | フィールド | 内容                                   |
  | --- | ----- | ------------------------------------ |
  | A   | シート名  | 例：`課題一覧`                             |
  | B   | リンク   | `=HYPERLINK("#gid=<シートID>", "課題一覧")` |

* **用途**：教師向けに各シートの一覧とリンクを表示するナビゲーション。

#### 4.2.2 `課題一覧`

* **列構成**

  | 列番号 | フィールド        | 型             | 内容                                                             |
  | --- | ------------ | ------------- | -------------------------------------------------------------- |
  | A   | 課題ID         | 文字列 (UUID)    | `Utilities.getUuid()` で生成。                                     |
  | B   | 問題データ (JSON) | 文字列           | `{ subject: "国語", question: "問題文…", type: "short"/"radio"/… }` |
  | C   | 自己評価許可       | 真偽値 (boolean) | `true` または `false`                                             |
  | D   | 作成日時         | 日付 (Date)     | 課題作成日時を `new Date()` で自動保存。                                    |
  | E   | ペルソナ         | 文字列           | 「小学生向け」「中学生向け」「教師向け」など、AIフィードバック用ペルソナ情報。                       |

* **用途**：教師が作成したすべての課題データを管理するためのリスト。

#### 4.2.3 `生徒一覧`

* **列構成**

  | 列番号 | フィールド    | 型         | 内容                          |
  | --- | -------- | --------- | --------------------------- |
  | A   | 生徒ID     | 文字列       | `<学年>-<組>-<番号>` (例：`6-1-1`) |
  | B   | 学年       | 文字列       | `"1"` ～ `"6"`               |
  | C   | 組        | 文字列       | 英字1文字                       |
  | D   | 番号       | 文字列       | `"1"` ～ `"99"`              |
  | E   | 初回ログイン日時 | 日付 (Date) | `initStudent` 呼び出し時に自動保存。   |

* **用途**：クラスに所属する全生徒の基本情報を保持し、IDから個別シートを参照する。

#### 4.2.4 `回答ログ（全体ボード用）`

* **列構成**

  | 列番号 | フィールド    | 型   | 内容                                  |
  | --- | -------- | --- | ----------------------------------- |
  | A   | 日時       | 日付  | 回答送信時のタイムスタンプ (`new Date()`)        |
  | B   | 生徒ID     | 文字列 | `<学年>-<組>-<番号>` (例：`6-1-1`)         |
  | C   | 課題ID     | 文字列 | `課題一覧` からのUUID                      |
  | D   | 回答概要     | 文字列 | 回答本文を先頭50文字まで切り取り、末尾に「…」を付与した文字列。   |
  | E   | 付与XP     | 数値  | 回答で獲得したXP (例：20)                    |
  | F   | 累積XP     | 数値  | 回答後の累積XP                            |
  | G   | レベル      | 数値  | 回答後のレベル                             |
  | H   | トロフィー    | 文字列 | 回答で新たに獲得したトロフィー名（カンマ区切り）。未獲得時は空文字列。 |
  | I   | AI呼び出し回数 | 数値  | 児童がその課題でAIフィードバックを呼び出した回数（1～2）      |
  | J   | 回答回数     | 数値  | 児童がその課題に対して回答した回数（1～3）              |

* **用途**：直近30件を「回答ボード」に表示。全回答履歴としては保持しないが、30件以上は行として蓄積される。

#### 4.2.5 `AIフィードバックログ`

* **列構成**

  | 列番号 | フィールド      | 型   | 内容                                   |
  | --- | ---------- | --- | ------------------------------------ |
  | A   | 日時         | 日付  | AIフィードバック送信時のタイムスタンプ (`new Date()`)  |
  | B   | 生徒ID       | 文字列 | `<学年>-<組>-<番号>` (例：`6-1-1`)          |
  | C   | 課題ID       | 文字列 | `課題一覧` からのUUID                       |
  | D   | 回答回数（回答機会） | 数値  | 児童がその課題に何回目の回答を行ったか（1～3）             |
  | E   | AI呼び出し回数   | 数値  | 児童がその課題でAIフィードバックを何回目呼び出したか（1～2）     |
  | F   | 回答本文       | 文字列 | 児童が入力した回答                            |
  | G   | フィードバック内容  | 文字列 | Gemini APIから返却されたフィードバック文（プレーンテキスト）。 |

* **用途**：児童がAIフィードバックを受けた履歴を記録し、教育的なヒントや問いかけを後から参照可能とする。

#### 4.2.6 `Student_<studentId>`（動的作成）

* **列構成**

  | 列番号 | フィールド | 型   | 内容                                 |
  | --- | ----- | --- | ---------------------------------- |
  | A   | 日時    | 日付  | 回答送信時のタイムスタンプ (`new Date()`)       |
  | B   | 課題ID  | 文字列 | `課題一覧` からのUUID                     |
  | C   | 課題内容  | 文字列 | 回答当時の問題文（JSONの`question`を抽出）       |
  | D   | 回答本文  | 文字列 | 生徒が入力した回答テキスト                      |
  | E   | 付与XP  | 数値  | 回答により獲得したXP (例：20)                 |
  | F   | 累積XP  | 数値  | 回答直後の累積XP                          |
  | G   | レベル   | 数値  | 回答直後のレベル                           |
  | H   | トロフィー | 文字列 | 回答直後に獲得したトロフィー名（カンマ区切り）。未獲得時は空文字列。 |
  | I   | 回答回数  | 数値  | その課題に対する回答回数（1～3）                  |

* **用途**：

  1. \*\*「同一課題IDに複数回答しても必ず行追加」\*\*し、すべての回答履歴を保持。
  2. 各行に「付与XP」「累積XP」「レベル」「トロフィー」を含めることで、回答時点の学習ステータスを明確に記録。
  3. **回答回数**を管理し、3回を超えた場合は同一課題の送信不可と判定。
  4. シートの最終行を参照するだけで、現時点の累積XP、レベル、獲得済みトロフィー、回答回数を把握可能。

---

## 5. データモデル（エンティティ・リレーション）

1. **教師（Teacher）**

* `teacherCode` (PK)：文字列（6桁英数字）
* `sheetId`：スクリプトプロパティに保存されるスプレッドシートID
* （将来的に：教師名、メールアドレス、所属などを拡張）

2. **生徒（Student）**

* `studentId` (PK)：文字列（例：`6-1-1`）
* `grade`：文字列（`"1"`～`"6"`）
* `classroom`：文字列（英字1文字）
* `number`：文字列（`"1"`～`"99"`）
* `firstLogin`：日付（初回ログイン日時）
* `累積XP`、`レベル`、`獲得トロフィー`、`回答回数`は、`Student_<studentId>`シート最終行から参照可能（エンティティ属性としては保持しない）。

3. **課題（Task）**

* `taskId` (PK)：文字列（UUID）
* `teacherCode` (FK)：文字列
* `problemData`：文字列（JSON `{ subject, question, type, choices? }`）
* `selfEvalAllowed`：真偽値（boolean）
* `createdAt`：日付
* `persona`：文字列（「小学生向け」「中学生向け」など、AIフィードバック用）

4. **回答ログ（AnswerLog）**（全体ボード用）

* `logId` (PK, 自動採番)：数値
* `teacherCode` (FK)：文字列
* `studentId` (FK)：文字列
* `taskId` (FK)：文字列
* `answerSummary`：文字列
* `earnedXp`：数値
* `totalXp`：数値
* `level`：数値
* `trophies`：文字列（カンマ区切り）
* `aiCalls`：数値（1～2）
* `attempts`：数値（1～3）
* `timestamp`：日付

5. **AIフィードバックログ（AIFeedbackLog）**

* `logId` (PK, 自動採番)：数値
* `teacherCode` (FK)：文字列
* `studentId` (FK)：文字列
* `taskId` (FK)：文字列
* `answerAttemptCount`：数値（1～3）
* `aiCallCount`：数値（1～2）
* `studentAnswer`：文字列
* `feedbackText`：文字列
* `timestamp`：日付

6. **生徒履歴（StudentHistory）**（`Student_<studentId>`シート）

* `historyId` (PK, 行番号相当)：数値
* `studentId` (FK)：文字列
* `taskId` (FK)：文字列
* `question`：文字列
* `answerText`：文字列
* `earnedXp`：数値
* `totalXp`：数値
* `level`：数値
* `trophies`：文字列（カンマ区切り）
* `answerAttemptCount`：数値（1～3）
* `timestamp`：日付

---

## 6. 非機能要件

1. **データ保存・整合性**

* **回答は上書きせず常に行追加**する方式。過去回答履歴は保持し続ける。
* **AIフィードバックログ**は専用シートに記録し、呼び出し回数と回答回数を確実に把握できるようにする。
* **XP/レベル/トロフィーの計算**は、クライアント側とサーバー側で同一ロジックを持ち、サーバー側で再計算→照合し、異なる場合はサーバー側結果を優先してデータを書き換える。
* **累積XP・レベル・トロフィー・回答回数**は、`Student_<studentId>`シートの最終行から常に取得可能。

2. **パフォーマンス**

* **最適化**：

  * 全生徒シート走査時、各シートの最終行参照には`getLastRow()`を使用。
  * より高速化が必要な場合は、「生徒一覧」シートに最終行インデックスを格納し、実行時に直接参照する方針を導入可能。
* **GAS呼び出し制限**を考慮し、同一ページ内で連続呼び出しを抑制。

3. **セキュリティ**

* Webアプリ権限：`executeAs: USER_ACCESSING` → 各ユーザーの権限でSpreadsheet操作を行う。
* アクセス：`ANYONE` → ただし内部ロジックで教師コードチェック、入力バリデーション強化を実施。
* **データバリデーション**：教師コード・生徒IDの形式チェック、各入力データはエスケープ処理を行い、XSS/CSRF対策を講じる。

4. **運用・保守性**

* GASコードはGitなどでバージョン管理し、デプロイごとにタグ付与。
* 定期バックアップ：毎週末にスプレッドシートを別名コピーし、すべてのシートデータを含めて保存。
* トラブル時のログ：

  * GAS側：`console.log()`→Stackdriver Logging
  * クライアント側：デバッグパネルに詳細表示
* **拡張性**：今後、レベルごとのバッジ表示やランキング機能などを追加可能。

5. **ブラウザ互換性**

* モダンブラウザ（Chrome, Edge, Safari, Firefox）対応。
* IE系ブラウザは対象外。

---

## 7. 画面要件（UI要件詳細）

### 7.1 ログイン画面（共通）

* **項目**

  * テキスト入力欄：教師コード、生徒ID（学年-組-番号）
  * 入力形式チェック：全角数字→半角数字に変換、全角英字→半角大文字変換を行う。
  * ボタン：「ログイン」
  * **バリデーション**：未入力→「入力してください」、形式誤り→「形式が正しくありません」
  * **レイアウト**：中央寄せ、大きめのフォントとボタンで小学生でも操作しやすいデザイン。

### 7.2 管理パネル（`manage.html`）

* **ヘッダー**

  * 左：StudyQuestロゴ
  * 右：

    * 「回答ボードを見る」リンク
    * **教師コード表示**（例：`CODE: ABC123`、クリックで拡大表示）
    * 課題数（アイコン＋件数）
    * **生徒数表示**（`生徒一覧`シートから取得した登録生徒数）
    * **Gemini API設定**：

      * APIキー入力欄
      * ペルソナ選択ドロップダウン（「小学生向け」「中学生向け」「教師向け」など）
* **メインエリア（2カラム）**

  * **左：課題作成フォーム**
  * **右：課題一覧カード**

### 7.3 クエストボード（`input.html`）

* **XP/レベル表示**

  * XPバーコンポーネント（幅100%）
  * 「レベル：<数値>」リアルタイム更新
  * トロフィーポップアップアニメーション

* **クエスト一覧カード**

  * 未回答／回答済みのスタイル区別
  * カードクリックで詳細表示
  * 回答済みカードはグレーアウトし、完了済みリストに移動

* **詳細エリア**

  * 課題詳細（教科名、問題文）
  * 回答入力欄（テキストエリア or 選択肢）
  * 送信ボタン（GSAPアニメーション）
  * AIフィードバックボタン（Gemini API呼び出し、ペルソナ適用）
  * AI呼び出し残回数表示（「AIヒント残り：<回数>」）
  * 回答残回数表示（「回答残りチャンス：<回数>」）
  * 履歴モーダルボタン

* **履歴モーダル**

  * テーブル表示：日時、課題ID、回答本文、付与XP、累積XP、レベル、トロフィー、回答回数

* **AIフィードバックモーダル**

  * タイプライター演出でフィードバック表示

* **デバッグパネル**

  * GAS呼び出しログ表示（非表示可能）

### 7.4 回答ボード（`board.html`）

* **カードレイアウト**

  * グリッド表示（4列→2列→1列のレスポンシブ対応）
  * カード要素：生徒ID、回答要約/全文、付与XP、累積XP、レベル、トロフィー、AIヒント利用回数、回答回数
  * GSAP回転フェードインアニメーション
  * 15秒おき自動更新

---

## 8. テスト計画（サマリ）

1. **単体テスト**

   * `generateTeacherCode()` → 重複生成チェック
   * `submitAnswer()` → 行追加動作
   * `getStudentHistory()` → 履歴取得
   * `getStatistics()` → 生徒数/課題数/各生徒情報取得
   * `callGeminiAPI_GAS(prompt, persona)` → Gemini連携動作
   * `logToSpreadsheet(logData)` → AIログ保存

2. **結合テスト**

   * 教師初回ログイン→フォルダ/スプレッドシート作成→生徒ログイン→個別フォルダ/ファイル作成→クエストロード→回答送信→XP/レベル/トロフィー更新
   * AIフィードバック機能テスト
   * 回答回数制限テスト

3. **UIテスト**

   * 各画面レスポンシブ表示
   * GSAPアニメーション検証
   * フィードバックタイプライター演出検証
   * 生徒数表示／教師コード拡大表示検証

4. **セキュリティテスト**

   * 無効入力時のエラー表示
   * XSS/CSRF対策検証

5. **パフォーマンステスト**

   * `getStatistics()` 実行時間測定
   * 回答ボード読み込み時間測定

---

## 9. まとめ

本要件定義書では、以下のポイントを網羅的に設計しました。

* **生徒個別シート構造**：同一課題に複数回答した場合でも履歴をすべて保持し、付与XP・累積XP・レベル・トロフィー・回答回数を記録。
* **AIフィードバック機能強化**：Gemini API連携、ペルソナ選択、小学生向け/中学生向けなどテンプレート切り替え可能。
* **管理パネルの改修要件**：

  * **生徒数表示**：実際の登録生徒数を表示。
  * **教師コード拡大表示**：クリックで大きく表示し、生徒が入力しやすいUI。
  * **Gemini API設定エリア**：APIキー入力欄およびペルソナ選択。
* **生徒Drive連携**：生徒ログイン時に生徒のGoogle Driveに専用フォルダ/ファイルを作成し、回答ログのバックアップを保存可能（オプション）。

  * フォルダ名：`StudyQuest_Stu_<教師コード>_<studentId>`
  * 個別ファイル：`Responses_<studentId>.csv` または `Responses_<studentId>.gsheet`
* **ログイン入力のバリデーション強化**：教師コード・学年・組・番号の自動半角変換と大文字化、範囲チェックを徹底。

以上を基盤として、児童の学習体験向上および教師の指導支援を実現できるよう設計を進めてください。

---

## 10. 追加要件検討シミュレーション

### 10.1 シミュレーションの前提

**登場人物**

* **教育者（A）**：

  * 長年小学校教諭として児童の学びや成長を支援。教育者視点で要件を検討。
* **ゲームクリエイター（B）**：

  * ゲーム的演出やUX設計に精通。児童の興味・モチベーションを高めるアイデアを提供。
* **プログラマー（C）**：

  * Webアプリ開発、Google Apps Script、スプレッドシート構造に詳しい技術者。技術的制約を踏まえて要件を調整。

**議題**：

1. 管理画面右上「生徒数」を累計ログイン回数ではなく、**登録されている生徒数**に変更
2. 管理画面にGemini API設定欄＆**ペルソナ選択機能**を追加
3. 教師コードクリックで**拡大表示**するUI追加
4. 生徒のGoogle Driveに**専用フォルダ／ファイルを作成**し、ログを保存する仕組み
5. 以降のログインは学年・組・番号のみで可能とする要件

---

### 10.2 シミュレーション対話

#### A（教育者）

「今回の要望は、教師画面で表示する生徒数を累計ログイン回数ではなく、**登録されている生徒数**に変更することから始まります。これによって実際のクラス人数を把握しやすくなりますよね。そして、Gemini APIのペルソナ設定を追加し、フィードバックの文体や内容を調整できるようになれば、児童向けの表現をさらに最適化できると考えています。

また、教師コードを画面上でクリックすると拡大表示される仕組みを導入し、児童が自分のログイン画面ですばやく入力できるようにしたいです。さらに、各生徒のGoogle Driveに専用フォルダやファイルを作成しておけば、ローカルでも学習履歴を閲覧でき、保護者にも共有しやすくなりますね。二回目以降のログインは学年・組・番号だけで済むようにしておけば、児童の入力負担も軽減できると思います。」

#### B（ゲームクリエイター）

「A先生のおっしゃるとおりです。**生徒数のカウント方法**は、既に`生徒一覧`シートに登録されているIDの数を参照すればよいので、累計ログインではなく、単純に行数から計算できます。UI上ではヘッダー部分の生徒数表示にリアルタイムに反映させるだけです。

次に**Gemini APIのペルソナ設定**ですが、小学生向け・中学生向け・教師向けなど、選択肢をプルダウンで用意し、それに応じたシステムプロンプトを切り替えるイメージです。例えば「小学生向け」を選ぶと、『小学校高学年の児童が理解しやすい言葉遣いで』といった形でペルソナを指定します。これにより、フィードバックのトーンや語彙レベルが最適化され、児童のモチベーション向上につながります。

**教師コードの拡大表示**は簡単で、カードのようにクリックするとモーダルやポップアップが大きく表示されるだけ。デザイン的にもゲームっぽく、拡大アニメーションを付けると楽しいかもしれません。

**生徒Driveへの専用フォルダ／ファイル作成**については、ログイン時にGASを通じて該当生徒のDriveフォルダを作るか、すでにあるか確認しつつ作成すれば良いです。そのフォルダにCSVファイルやSpreadsheetを生成して学習ログをエクスポートできれば、保護者や家庭学習でも参照しやすくなります。

最後に、**以降のログインを学年・組・番号だけにする**には、スクリプトプロパティやDrive上で『教師コード+生徒ID』の組み合わせで認証し、Cookieやローカルストレージに一度保存すれば、次回以降自動で入力されるようにすれば実現可能です。」

#### C（プログラマー）

「A先生、Bさんのご提案は技術的にも実装可能です。以下に各ポイントの詳細検討を行います。

1. **生徒数表示の修正**

   * 現在の実装では`getStatistics()`がログイン回数をカウントしていますが、`生徒一覧`シートの最終行数を取得し、ヘッダー行を引いた値を返却するように変更します。
   * 具体的には：

   ```js
   function getStatistics(teacherCode) {
     const ss = getSpreadsheetByTeacherCode(teacherCode);
     if (!ss) return { taskCount: 0, studentCount: 0, stats: [] };
     const taskSheet = ss.getSheetByName(SHEET_TASKS);
     const studentSheet = ss.getSheetByName(SHEET_STUDENTS);
     const taskCount = taskSheet ? Math.max(0, taskSheet.getLastRow() - 1) : 0;
     const studentCount = studentSheet ? Math.max(0, studentSheet.getLastRow() - 1) : 0;
     return { taskCount, studentCount, stats: [] };
   }
   ```

   * 管理画面では受け取った`studentCount`を表示する。

2. **教師コード拡大表示UI**

   * HTML側で教師コードテキストをクリックするとモーダルを表示する実装を行う。TailwindCSSを用いてデザイン。
   * 例：

   ```html
   <div id="teacher-code-display" class="cursor-pointer" onclick="showTeacherCodeModal()">CODE: ABC123</div>
   <div id="teacher-code-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
     <div class="bg-white p-8 rounded-lg text-3xl font-bold">ABC123</div>
   </div>
   ```

   * JavaScript：

   ```js
   function showTeacherCodeModal() {
     document.getElementById('teacher-code-modal').classList.remove('hidden');
   }
   document.getElementById('teacher-code-modal').addEventListener('click', () => {
     document.getElementById('teacher-code-modal').classList.add('hidden');
   });
   ```

3. **Gemini API設定＆ペルソナ選択**

   * 管理パネルにテキスト入力（APIキー）とドロップダウン（ペルソナ選択）を追加。
   * GAS側関数`createTask`および`callGeminiAPI_GAS`にペルソナ引数を追加し、プロンプト作成時に活用。
   * 例：

   ```js
   function callGeminiAPI_GAS(prompt, persona) {
     const basePrompt = {
       '小学生向け': 'あなたは小学校高学年以上向けの優しい先生です。',
       '中学生向け': 'あなたは中学生向けの適切な言葉遣いをする先生です。',
       '教師向け':   'あなたは現役教師が使用するプロンプト形式です。'
     }[persona] || '';
     const finalPrompt = basePrompt + '\n' + prompt;
     // Gemini API 呼び出しロジック
   }
   ```

4. **生徒Driveへの専用フォルダ／ファイル作成**

   * 生徒初回ログイン時に以下を実行：

     1. `DriveApp.getFoldersByName('StudyQuest_Stu_<teacherCode>_<studentId>')` を確認。
     2. 存在しなければ `DriveApp.createFolder('StudyQuest_Stu_<teacherCode>_<studentId>')` を作成。
     3. フォルダ内に `Responses_<studentId>.csv` または `Responses_<studentId>.gsheet` を作成し、ヘッダー行をセット。
   * `submitAnswer`時に個別ファイルへもログを追記する処理を実装。

5. **二回目以降のログイン簡略化**

   * クライアント側でLocalStorageに`teacherCode`を保存し、次回自動入力。
   * サーバー側でもDriveフォルダ存在チェックと一致する教師コードかバリデーション。

---
