<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest â€“ ãƒ­ã‚°ã‚¤ãƒ³</title>
  <!-- ã‚²ãƒ¼ãƒ ã£ã½ã„ãƒ‰ãƒƒãƒˆãƒ•ã‚©ãƒ³ãƒˆ -->
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
  <!-- TailwindCSS + GSAP -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'DotGothic16', monospace; }
    #particleCanvas {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; z-index: -1;
    }
    /* åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #firstMessage {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center; justify-content: center;
    }
    #firstMessage .modal {
      background: #1f2937; padding: 1.5rem; border-radius: 1rem;
      max-width: 90%; color: #fff; font-size: 0.875rem;
    }
    #firstMessage button {
      margin-top: 1rem; padding: 0.5rem 1rem; background: #ec4899;
      border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-b from-indigo-900 to-gray-900 text-white">

  <!-- èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="particleCanvas"></canvas>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹ -->
  <div id="loginBox" class="bg-gray-900/80 p-8 rounded-2xl shadow-2xl w-80 md:w-96 text-center">
    <h1 class="text-3xl mb-4 tracking-widest drop-shadow-lg">
      Study<span class="text-pink-400">Quest</span>
    </h1>
    <form id="loginForm" class="space-y-4 text-sm">
      <!-- æ•™å¸«ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
      <label class="block text-left text-xs cursor-pointer">
        <input type="checkbox" id="teacherMode" /> ç§ã¯æ•™å¸«ã§ã™
      </label>

      <!-- æ•™å¸«ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ -->
      <div id="passcodeWrap" class="hidden">
        <input
          id="passcode"
          type="password"
          placeholder="æ•™å¸«ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆkyoushiï¼‰"
          class="w-full p-2 rounded bg-gray-800 placeholder-gray-500 focus:outline-none"
        />
      </div>

      <!-- å…ç«¥ç”¨ï¼šæ•™å¸«ã‚³ãƒ¼ãƒ‰ -->
      <div id="teacherCodeWrap">
        <input
          id="teacherCode"
          type="text"
          maxlength="6"
          placeholder="æ•™å¸«ã‚³ãƒ¼ãƒ‰ (6æ¡è‹±æ•°å­—)"
          class="w-full p-2 rounded bg-gray-800 placeholder-gray-500 focus:outline-none"
          required
        />
      </div>
      <div id="teacherCodeDisplay" class="text-xs text-gray-400 mb-2 hidden"></div>

      <!-- å…ç«¥ç”¨ï¼šå­¦å¹´ãƒ»çµ„ãƒ»ç•ªå· -->
      <div id="studentFields" class="space-y-2">
        <input
          id="grade"
          type="number"
          min="1"
          max="6"
          placeholder="å­¦å¹´"
          class="w-full p-2 rounded bg-gray-800 focus:outline-none"
          required
        />
        <input
          id="classroom"
          type="text"
          maxlength="1"
          placeholder="çµ„"
          class="w-full p-2 rounded bg-gray-800 focus:outline-none"
          required
        />
        <input
          id="number"
          type="number"
          min="1"
          max="99"
          placeholder="ç•ªå·"
          class="w-full p-2 rounded bg-gray-800 focus:outline-none"
          required
        />
      </div>

      <button
        id="loginBtn"
        type="submit"
        class="w-full py-2 bg-pink-600 hover:bg-pink-500 rounded-xl shadow-lg uppercase tracking-widest transform transition-all duration-200"
      >
        ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </form>
    <p id="loading" class="mt-3 text-xs text-gray-400 hidden">é€šä¿¡ä¸­â€¦</p>
  </div>

  <!-- åˆå›ãƒ­ã‚°ã‚¤ãƒ³ç”¨æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰-->
  <div id="firstMessage">
    <div class="modal">
      <p>ğŸ‰ åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
      <p>ã“ã‚Œã‹ã‚‰ Google Drive ä¸Šã«</p>
      <p><strong>ã€ŒStudyQuest_<span id="newCodeSpan"></span>ã€</strong>ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
      <p>å…ç«¥ã®çš†ã•ã‚“ã«ã¯ã€Œæ•™å¸«ã‚³ãƒ¼ãƒ‰ï¼ˆ<span id="newCodeSpan2"></span>ï¼‰ã€ã‚’ãŠä¼ãˆãã ã•ã„ã€‚</p>
      <p>â€»æ—¢ã«åŒåãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã®ã§ã”æ³¨æ„ã‚’ã€‚</p>
      <button id="closeFirstMsg">äº†è§£ã—ã¾ã—ãŸ</button>
    </div>
  </div>

  <!-- exec URL ã‚’åŸ‹ã‚è¾¼ã‚€ -->
  <script>
    <?!= "const SCRIPT_URL = '" + scriptUrl + "';" ?>
  </script>

  <script>
    // ==============================
    // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    // ==============================
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const maxParticles = 80;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.3;
        this.vy = (Math.random() - 0.5) * 0.3;
        this.size = Math.random() * 2 + 1;
        this.alpha = Math.random() * 0.5 + 0.3;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        if (
          this.x < 0 || this.x > canvas.width ||
          this.y < 0 || this.y > canvas.height
        ) {
          this.reset();
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
        }
      }
      draw() {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      for (let i = 0; i < maxParticles; i++) {
        particles.push(new Particle());
      }
    }
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      requestAnimationFrame(animateParticles);
    }
    initParticles();
    animateParticles();

    // ==============================
    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ==============================
    document.addEventListener('DOMContentLoaded', () => {
      gsap.from('#loginBox', { scale: 0, duration: 0.6, ease: 'back' });
      const savedCode = localStorage.getItem('teacherCode');
      if (savedCode) {
        document.getElementById('teacherCode').value = savedCode;
        document.getElementById('teacherCodeWrap').classList.add('hidden');
        const disp = document.getElementById('teacherCodeDisplay');
        disp.textContent = `æ•™å¸«ã‚³ãƒ¼ãƒ‰: ${savedCode}`;
        disp.classList.remove('hidden');
      }
      toggleTeacherMode();
      document.getElementById('teacherMode').addEventListener('change', toggleTeacherMode);
      document.getElementById('loginForm').addEventListener('submit', handleSubmit);
      document.getElementById('teacherCode').addEventListener('input', normalizeTeacherCode);
      document.getElementById('grade').addEventListener('input', e => { e.target.value = toHalf(e.target.value.replace(/[^0-9]/g,'')); });
      document.getElementById('number').addEventListener('input', e => { e.target.value = toHalf(e.target.value.replace(/[^0-9]/g,'')); });
      document.getElementById('classroom').addEventListener('input', e => { e.target.value = toHalf(e.target.value).toUpperCase().replace(/[^A-Z]/g,''); });
    });

    function toHalf(str) {
      return str.replace(/[\uff01-\uff5e]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
    }

    function normalizeTeacherCode() {
      const el = document.getElementById('teacherCode');
      el.value = toHalf(el.value).toUpperCase().replace(/[^A-Z0-9]/g,'');
    }

    function toggleTeacherMode() {
      const isTeacher = document.getElementById('teacherMode').checked;
      const passWrap = document.getElementById('passcodeWrap');
      const codeWrap = document.getElementById('teacherCodeWrap');
      const codeDisp = document.getElementById('teacherCodeDisplay');
      const studentFields = document.getElementById('studentFields');
      const savedCode = localStorage.getItem('teacherCode');

      if (isTeacher) {
        passWrap.classList.remove('hidden');
        codeWrap.classList.add('hidden');
        studentFields.classList.add('hidden');
        document.getElementById('passcode').required = true;
        document.getElementById('teacherCode').required = false;
        document.getElementById('grade').required = false;
        document.getElementById('classroom').required = false;
        document.getElementById('number').required = false;
      } else {
        passWrap.classList.add('hidden');
        if (savedCode) {
          codeWrap.classList.add('hidden');
          codeDisp.textContent = `æ•™å¸«ã‚³ãƒ¼ãƒ‰: ${savedCode}`;
          codeDisp.classList.remove('hidden');
        } else {
          codeWrap.classList.remove('hidden');
          codeDisp.classList.add('hidden');
        }
        studentFields.classList.remove('hidden');
        document.getElementById('passcode').required = false;
        document.getElementById('teacherCode').required = true;
        document.getElementById('grade').required = true;
        document.getElementById('classroom').required = true;
        document.getElementById('number').required = true;
      }
    }

    function handleSubmit(e) {
      e.preventDefault();
      const isTeacher = document.getElementById('teacherMode').checked;
      const loading = document.getElementById('loading');
      const btn = document.getElementById('loginBtn');
      loading.classList.remove('hidden');
      btn.disabled = true;

      // ãƒœã‚¿ãƒ³ãƒã‚¦ãƒ³ãƒ‰
      gsap.to(btn, { scale: 1.05, duration: 0.1 }).then(() => {
        gsap.to(btn, { scale: 1, duration: 0.1 });
      });

      if (isTeacher) {
        // â”€â”€ æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ â”€â”€
        const passcode = document.getElementById('passcode').value.trim();
        if (passcode !== 'kyoushi') {
          alert('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
          loading.classList.add('hidden');
          btn.disabled = false;
          return;
        }
        google.script.run
          .withSuccessHandler(result => {
            const { status, teacherCode, message } = result;

            if (status === 'new') {
              // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚
              document.getElementById('newCodeSpan').textContent = teacherCode;
              document.getElementById('newCodeSpan2').textContent = teacherCode;
              document.getElementById('firstMessage').style.display = 'flex';

              document.getElementById('closeFirstMsg').onclick = () => {
                document.getElementById('firstMessage').style.display = 'none';
                window.top.location.href = SCRIPT_URL + '?page=manage&teacher=' + teacherCode;
              };
            }
            else if (status === 'ok') {
              // 2å›ç›®ä»¥é™
              alert('ãŠã‹ãˆã‚Šãªã•ã„ï¼');
              window.top.location.href = SCRIPT_URL + '?page=manage&teacher=' + teacherCode;
            }
            else {
              // error
              alert(message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
              loading.classList.add('hidden');
              btn.disabled = false;
            }
          })
          .withFailureHandler(err => {
            alert('æ•™å¸«ãƒ­ã‚°ã‚¤ãƒ³ã§ã‚¨ãƒ©ãƒ¼: ' + err.message);
            loading.classList.add('hidden');
            btn.disabled = false;
          })
          .initTeacher(passcode);

      } else {
        // â”€â”€ å…ç«¥ãƒ¢ãƒ¼ãƒ‰ â”€â”€
        const saved = localStorage.getItem('teacherCode');
        const teacherCode = (saved || document.getElementById('teacherCode').value).trim().toUpperCase();
        const grade = document.getElementById('grade').value.trim();
        const classroom = document.getElementById('classroom').value.trim().toUpperCase();
        const number = document.getElementById('number').value.trim();

        if (!teacherCode) {
          alert('æ•™å¸«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          loading.classList.add('hidden');
          btn.disabled = false;
          return;
        }
        if (!grade || !classroom || !number) {
          alert('å­¦å¹´ãƒ»çµ„ãƒ»ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          loading.classList.add('hidden');
          btn.disabled = false;
          return;
        }

        const studentParams = new URLSearchParams({
          grade: grade,
          class: classroom,
          number: number,
          teacher: teacherCode
        }).toString();

        google.script.run
          .withSuccessHandler(() => {
            localStorage.setItem('teacherCode', teacherCode);
            window.top.location.href = SCRIPT_URL + '?page=input&' + studentParams;
          })
          .withFailureHandler(err => {
            alert('å…ç«¥ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—: ' + err.message);
            loading.classList.add('hidden');
            btn.disabled = false;
          })
          .initStudent(teacherCode, grade, classroom, number);
      }
    }
  </script>

</body>
</html>
