<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest - ログイン画面 新レイアウト案</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Lucide Icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.395.0/dist/lucide.min.js" defer></script>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      background-color: #1a1b26;
      overflow: hidden;
    }
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    .glass-panel {
      background: rgba(26, 27, 38, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .game-btn {
      transition: all 0.2s ease;
      border-bottom-width: 4px;
    }
    .game-btn:active {
      transform: translateY(2px);
      border-bottom-width: 2px;
    }
    input, select {
      background-color: rgba(20, 21, 30, 0.8);
      border: 1px solid #4a4f8a;
    }
    input:focus, select:focus {
      outline: none;
      --tw-ring-color: #f472b6;
      --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
      --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
      box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
      border-color: #f472b6;
    }
    input[type="checkbox"] {
      appearance: none;
      background-color: rgba(20, 21, 30, 0.8);
      border: 1px solid #4a4f8a;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 0.25rem;
      display: inline-block;
      position: relative;
      vertical-align: middle;
      cursor: pointer;
    }
    input[type="checkbox"]:checked {
      background-color: #ec4899;
      border-color: #f472b6;
    }
    input[type="checkbox"]:checked::after {
      content: '✔';
      position: absolute;
      color: white;
      font-size: 0.8rem;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    /* debug panel styles from original */
    #debugPanel {
      position: fixed;
      bottom: 3rem;
      right: 1rem;
      width: 320px;
      max-height: 200px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #4b5563;
      border-radius: 0.5rem;
      overflow-y: auto;
      padding: 0.75rem;
      font-size: 0.75rem;
      line-height: 1.2;
      color: #d1d5db;
      z-index: 50;
    }
    #debugPanelHeader {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #debugClose {
      cursor: pointer;
      color: #f87171;
    }
    #versionInfo { cursor: pointer; }
    #loginBox {
      position: relative;
    }
    #loading {
      position: absolute;
      bottom: 1rem;
      left: 0;
      width: 100%;
      text-align: center;
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 50;
    }
    #firstMessage {
      z-index: 60;
    }
  </style>
</head>
<body class="text-gray-200 bg-gradient-to-br from-purple-800 to-indigo-700">

  <canvas id="particleCanvas"></canvas>

  <main class="min-h-screen flex items-center justify-center p-4">
    <section id="loginBox" class="glass-panel rounded-2xl p-8 w-full max-w-md shadow-2xl">
      <div class="text-center mb-6">
        <i data-lucide="swords" class="w-12 h-12 text-pink-400 mx-auto mb-2"></i>
        <h1 class="text-3xl font-bold tracking-widest text-white">StudyQuest</h1>
        <p class="text-gray-400 text-sm mt-1">冒険の準備をしよう！</p>
      </div>
      <form id="loginForm" class="space-y-4">
        <div class="mb-4">
          <label class="flex items-center gap-2 text-gray-400 text-sm cursor-pointer hover:text-white transition-colors">
            <input type="checkbox" id="teacherMode">
            <span>私は教師です</span>
          </label>
        </div>
        <div id="teacherCodeWrap" class="space-y-3">
          <div class="relative">
            <i data-lucide="hash" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            <input id="teacherCode" type="text" placeholder="教師コード" class="w-full p-3 pl-10 rounded-lg text-white" required list="teacherHistory">
            <datalist id="teacherHistory"></datalist>
          </div>
        </div>
        <div id="studentFields" class="space-y-3">
          <div class="grid grid-cols-3 gap-2">
            <input id="grade" type="number" placeholder="学年" class="w-full p-3 rounded-lg text-white" required>
            <input id="classroom" type="text" placeholder="組" class="w-full p-3 rounded-lg text-white" required>
            <input id="number" type="number" placeholder="番号" class="w-full p-3 rounded-lg text-white" required>
          </div>
        </div>
        <div id="passcodeWrap" class="hidden space-y-3">
          <div class="relative">
            <i data-lucide="key-round" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            <input id="passcode" type="password" placeholder="教師パスコード" class="w-full p-3 pl-10 rounded-lg text-white">
          </div>
        </div>
        <button id="loginBtn" type="submit" class="w-full game-btn bg-pink-600 text-white p-3 rounded-lg font-bold border-pink-800 hover:bg-pink-500 active:border-pink-700 flex items-center justify-center gap-2 mt-6">
          <i data-lucide="log-in" class="w-5 h-5 align-middle"></i>
          <span class="leading-none align-middle">Googleでサインイン</span>
        </button>
        <p id="loading" class="mt-3 text-xs text-gray-400 hidden">通信中…</p>
      </form>
    </section>
  </main>

  <!-- 初回ログイン用注意メッセージ（モーダル）-->
  <div id="firstMessage" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden">
    <div class="glass-panel modal rounded-2xl p-8 w-full max-w-md text-center shadow-2xl">
      <p class="mb-2">🎉 初回ログインありがとうございます！</p>
      <p class="mb-2">これから Google Drive 上に</p>
      <p class="mb-2"><strong>「StudyQuest_<span id="newCodeSpan"></span>」</strong>フォルダを作成します。</p>
      <p class="mb-4">生徒の皆さんには「教師コード（<span id="newCodeSpan2"></span>）」をお伝えください。</p>
      <p class="text-xs text-gray-300 mb-4">※既に同名フォルダがある場合は上書きされますのでご注意を。</p>
      <button id="closeFirstMsg" class="game-btn bg-indigo-600 text-white p-3 rounded-2xl font-bold border-indigo-800 hover:bg-indigo-500 active:border-indigo-700 w-full shadow-2xl">了解しました</button>
    </div>
  </div>

  <!-- exec URL -->
  <script>
    const SCRIPT_URL = '<?!= scriptUrl.replace("/dev", "/exec") ?>';
    const CLIENT_ID = 'YOUR_CLIENT_ID';
  </script>
  <script>
    // ==============================
    // 背景パーティクル
    // ==============================
    let debugContentElem;
    function debug(msg) {
      if (!debugContentElem) return;
      const t = new Date().toLocaleTimeString();
      debugContentElem.insertAdjacentHTML('beforeend', `<p>[${t}] ${msg}</p>`);
      debugContentElem.scrollTop = debugContentElem.scrollHeight;
    }
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const maxParticles = 80;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.3;
        this.vy = (Math.random() - 0.5) * 0.3;
        this.size = Math.random() * 2 + 1;
        this.alpha = Math.random() * 0.5 + 0.3;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        if (
          this.x < 0 || this.x > canvas.width ||
          this.y < 0 || this.y > canvas.height
        ) {
          this.reset();
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
        }
      }
      draw() {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      for (let i = 0; i < maxParticles; i++) {
        particles.push(new Particle());
      }
    }
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      requestAnimationFrame(animateParticles);
    }
    initParticles();
    animateParticles();

    // ==============================
    // ログイン画面のスクリプト
    // ==============================
    document.addEventListener('DOMContentLoaded', () => {
      debugContentElem = document.getElementById('debugContent');
      const debugPanel = document.getElementById('debugPanel');
      const versionEl = document.getElementById('versionInfo');
      const debugCloseBtn = document.getElementById('debugClose');
      versionEl.addEventListener('click', () => debugPanel.classList.toggle('hidden'));
      debugCloseBtn.addEventListener('click', () => debugPanel.classList.add('hidden'));

      debug('🔄 ページ読み込み完了');
      gsap.from('#loginBox', { scale: 0, duration: 0.6, ease: 'back' });
      let history = [];
      try {
        history = JSON.parse(localStorage.getItem('teacherCodeHistory') || '[]');
      } catch (_) {
        history = [];
      }
      const list = document.getElementById('teacherHistory');
      let html = '';
      history.forEach(code => { html += `<option value="${escapeHtml(code)}"></option>`; });
      list.innerHTML = html;
      toggleTeacherMode();
      document.getElementById('teacherMode').addEventListener('change', toggleTeacherMode);
      document.getElementById('loginForm').addEventListener('submit', handleSubmit);
      document.getElementById('teacherCode').addEventListener('input', normalizeTeacherCode);
      document.getElementById('grade').addEventListener('input', e => { e.target.value = toHalf(e.target.value.replace(/[^0-9]/g,'')); });
      document.getElementById('number').addEventListener('input', e => { e.target.value = toHalf(e.target.value.replace(/[^0-9]/g,'')); });
      // "組" は全角入力を許可し、Enter(送信)時に半角へ変換するため、リアルタイム変換は行わない
      setupFieldFocus();
    });

    function toHalf(str) {
      return str.replace(/[\uff01-\uff5e]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
    }

    function normalizeTeacherCode() {
      const el = document.getElementById('teacherCode');
      el.value = toHalf(el.value).toUpperCase().replace(/[^A-Z0-9]/g,'');
    }

    function addHistory(code) {
      code = String(code || '').toUpperCase();
      try {
        let list = JSON.parse(localStorage.getItem('teacherCodeHistory') || '[]');
        list = list.filter(c => c !== code);
        list.unshift(code);
        if (list.length > 5) list = list.slice(0,5);
        localStorage.setItem('teacherCodeHistory', JSON.stringify(list));
      } catch (_) {
        // Ignore storage errors
      }
    }

    function toggleTeacherMode() {
      const isTeacher = document.getElementById('teacherMode').checked;
      const passWrap = document.getElementById('passcodeWrap');
      const codeWrap = document.getElementById('teacherCodeWrap');
      const studentFields = document.getElementById('studentFields');

      if (isTeacher) {
        passWrap.classList.remove('hidden');
        codeWrap.classList.add('hidden');
        studentFields.classList.add('hidden');
        document.getElementById('passcode').required = true;
        document.getElementById('teacherCode').required = false;
        document.getElementById('grade').required = false;
        document.getElementById('classroom').required = false;
        document.getElementById('number').required = false;
      } else {
        passWrap.classList.add('hidden');
        codeWrap.classList.remove('hidden');
        studentFields.classList.remove('hidden');
        document.getElementById('passcode').required = false;
        document.getElementById('teacherCode').required = true;
        document.getElementById('grade').required = true;
        document.getElementById('classroom').required = true;
        document.getElementById('number').required = true;
      }
    }

    function handleSubmit(e) {
      e.preventDefault();
      clearError();
      const isTeacher = document.getElementById('teacherMode').checked;
      const btn = document.getElementById('loginBtn');
      showLoadingOverlay();
      btn.disabled = true;

      gsap.to(btn, { scale: 1.05, duration: 0.1 }).then(() => {
        gsap.to(btn, { scale: 1, duration: 0.1 });
      });

      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: response => {
          const idToken = response.credential;
          if (!idToken) {
            showError('Google認証に失敗しました');
            hideLoadingOverlay();
            btn.disabled = false;
            return;
          }

          if (isTeacher) {
            const passcode = document.getElementById('passcode').value.trim();
            google.script.run
              .withSuccessHandler(res => {
                const { status, teacherCode, message } = res;
                if (status === 'new') {
                  document.getElementById('newCodeSpan').textContent = teacherCode;
                  document.getElementById('newCodeSpan2').textContent = teacherCode;
                  document.getElementById('firstMessage').style.display = 'flex';
                  document.getElementById('closeFirstMsg').onclick = () => {
                    document.getElementById('firstMessage').style.display = 'none';
                    addHistory(teacherCode);
                    window.top.location.href = SCRIPT_URL + '?page=manage&teacher=' + teacherCode;
                  };
                } else if (status === 'ok') {
                  addHistory(teacherCode);
                  window.top.location.href = SCRIPT_URL + '?page=manage&teacher=' + teacherCode;
                } else {
                  showError(message || 'エラーが発生しました。');
                  hideLoadingOverlay();
                  btn.disabled = false;
                }
              })
              .withFailureHandler(err => {
                showError('教師ログインでエラー: ' + err.message);
                hideLoadingOverlay();
                btn.disabled = false;
              })
              .handleTeacherAuth(idToken, passcode);
          } else {
            const teacherCode = document.getElementById('teacherCode').value.trim().toUpperCase();
            const grade = document.getElementById('grade').value.trim();
            const classroom = toHalf(document.getElementById('classroom').value.trim()).toUpperCase();
            const number = document.getElementById('number').value.trim();

            if (!teacherCode || !grade || !classroom || !number) {
              showError('入力内容を確認してください。');
              hideLoadingOverlay();
              btn.disabled = false;
              return;
            }

            const info = { teacherCode, grade, classroom, number, studentId: `${grade}-${classroom}-${number}` };
            google.script.run
              .withSuccessHandler(() => {
                addHistory(teacherCode);
                const params = new URLSearchParams({ grade, class: classroom, number, teacher: teacherCode }).toString();
                window.top.location.href = SCRIPT_URL + '?page=quest&' + params;
              })
              .withFailureHandler(err => {
                showError('生徒登録でエラー: ' + err.message);
                hideLoadingOverlay();
                btn.disabled = false;
              })
              .registerStudentToClass(idToken, info);
          }
        }
      });
      google.accounts.id.prompt();

      // フォーカス移動設定
      function setupFieldFocus() {
        const teacherInput = document.getElementById('teacherCode');
        const gradeInput = document.getElementById('grade');
        const classInput = document.getElementById('classroom');
        const numberInput = document.getElementById('number');

        teacherInput.focus();

        teacherInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            gradeInput.focus();
          }
        });

        gradeInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            classInput.focus();
          }
        });

        classInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            numberInput.focus();
          }
        });
      }

      /**
       * Show the loading overlay.
       */
      function showLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('hidden');
      }

      /**
       * Hide the loading overlay.
       */
      function hideLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('hidden');
      }

      function showError(msg) {
        const el = document.getElementById('errorMessage');
        if (el) {
          el.textContent = msg;
          el.classList.remove('hidden');
        }
      }

      function clearError() {
        const el = document.getElementById('errorMessage');
        if (el) {
          el.textContent = '';
          el.classList.add('hidden');
        }
      }
    }
  </script>

  <!-- デバッグパネル（左下） -->
  <div id="debugPanel" class="hidden">
    <div id="debugPanelHeader">
      <span>デバッグログ</span>
      <span id="debugClose">✕</span>
    </div>
    <div id="debugContent"></div>
  </div>

  <!-- バージョン表示 -->
  <div id="versionInfo" class="fixed bottom-2 right-2 text-xs text-gray-400"><?= version ?></div>
  <div id="loadingOverlay" class="hidden flex items-center justify-center text-white text-xl font-bold select-none">ロード中…</div>
</body>
</html>
