<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest – チャット</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.259.0/dist/umd/lucide.min.js"></script>
  <style>
    body { font-family: 'DotGothic16', monospace; }
    #chatLog { height: 60vh; overflow-y: auto; }
    #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    @media (max-width: 768px) {
      #layout { flex-direction: column; }
      #leftPane, #rightPane { width: 100%; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-800 to-indigo-700 text-gray-100 flex flex-col p-4">
<canvas id="particleCanvas"></canvas>
<div class="w-full max-w-6xl mx-auto" id="layout">
  <div id="leftPane" class="md:w-2/5 p-4 space-y-6">
    <section>
      <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
        <svg data-icon="Target" class="w-6 h-6 text-pink-400"></svg>未回答クエスト
      </h2>
      <div id="unanswered" class="bg-gray-800 p-3 rounded-lg space-y-2 min-h-[80px]"></div>
    </section>
    <section>
      <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
        <svg data-icon="CheckCircle" class="w-6 h-6 text-indigo-400"></svg>完了済みクエスト
      </h2>
      <div id="answered" class="bg-gray-800 p-3 rounded-lg space-y-2 min-h-[80px]"></div>
    </section>
  </div>
  <div id="rightPane" class="md:w-3/5 bg-gray-800 rounded-2xl p-4 flex flex-col">
    <div id="chatLog" class="flex-1 space-y-3 overflow-y-auto"></div>
    <div id="inputArea" class="mt-4 space-y-2">
      <div id="answerInputs"></div>
      <div class="flex items-center gap-2">
        <button id="modeToggle" class="text-sm bg-gray-700 px-2 py-1 rounded">Gemini</button>
        <button id="sendBtn" class="flex items-center gap-1 bg-pink-600 hover:bg-pink-500 text-white px-4 py-1 rounded shadow">提出</button>
      </div>
    </div>
  </div>
</div>
<div class="w-full max-w-3xl mx-auto mt-6">
  <div class="flex justify-between items-center mb-1 text-sm">
    <span>Level <span id="playerLevel">1</span></span>
    <span><span id="xpCurrent">0</span> XP / <span id="xpNext">100</span> XP</span>
  </div>
  <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
    <div id="xpFill" class="h-full bg-pink-400 w-0"></div>
  </div>
</div>
<script>
const SCRIPT_URL = '<?!= scriptUrl.replace("/dev","/exec") ?>';
const teacherCode = '<?!= teacher ?>';
const grade = '<?!= grade ?>';
const classroom = '<?!= classroom ?>';
const number = '<?!= number ?>';
const version = '<?!= version ?>';
const studentId = `${grade}-${classroom}-${number}`;
let xp = 0;
let level = 1;
let totalXp = 0;
const xpPerQuest = 10;
let currentTask = null;
let mode = 'submit';
let aiCalls = 0;

function debug(msg) { console.log(msg); }

function renderIcons(scope) {
  if (window.lucide) {
    window.lucide.createIcons({ nameAttr: 'data-icon', icons: window.lucide.icons });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  renderIcons(document);
  initParticles();
  animateParticles();
  if (!teacherCode || !grade || !classroom || !number) {
    alert('不正なアクセス');
    return;
  }
  initStudent();
  document.getElementById('modeToggle').addEventListener('click', toggleMode);
  document.getElementById('sendBtn').addEventListener('click', onSend);
});

function toggleMode() {
  mode = mode === 'submit' ? 'gemini' : 'submit';
  const btn = document.getElementById('sendBtn');
  btn.textContent = mode === 'submit' ? '提出' : 'ヒント';
  document.getElementById('modeToggle').textContent = mode === 'submit' ? 'Gemini' : '提出';
}

function initStudent() {
  google.script.run.withSuccessHandler(() => { loadTasks(); loadXp(); })
    .withFailureHandler(e => alert('初期化失敗: ' + e.message))
    .initStudent(teacherCode, grade, classroom, number);
}

function loadTasks() {
  google.script.run.withSuccessHandler(tasks => {
    google.script.run.withSuccessHandler(history => {
      history = Array.isArray(history) ? history : [];
      renderLists(tasks || [], history);
    }).getStudentHistory(teacherCode, studentId);
  }).listTasks(teacherCode);
}

function renderLists(tasks, history) {
  const answeredIds = new Set(history.filter(r => (r[3] || '').toString().trim() !== '').map(r => r[1]));
  const unanswered = tasks.filter(t => !answeredIds.has(t.id));
  const answered = tasks.filter(t => answeredIds.has(t.id));
  const unEl = document.getElementById('unanswered');
  const anEl = document.getElementById('answered');
  unEl.innerHTML = '';
  anEl.innerHTML = '';
  unanswered.forEach(t => {
    const div = document.createElement('div');
    const q = JSON.parse(t.q);
    div.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600';
    div.textContent = `【${q.subject}】 ${q.question}`;
    div.addEventListener('click', () => openTask(t, history));
    unEl.appendChild(div);
  });
  answered.forEach(t => {
    const div = document.createElement('div');
    const q = JSON.parse(t.q);
    div.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 opacity-70 line-through';
    div.textContent = `【${q.subject}】 ${q.question}`;
    div.addEventListener('click', () => openTask(t, history));
    anEl.appendChild(div);
  });
  if (!currentTask && unanswered.length) openTask(unanswered[0], history);
}

function openTask(task, history) {
  currentTask = task;
  aiCalls = 0;
  const q = JSON.parse(task.q);
  const log = document.getElementById('chatLog');
  log.innerHTML = '';
  appendMsg('system', `【${q.subject}】 ${q.question}`);
  const rows = history.filter(r => r[1] === task.id);
  rows.forEach(r => appendMsg('student', r[3]));
  renderInput(q, rows.length);
  log.scrollTop = log.scrollHeight;
}

function renderInput(q, attempt) {
  const area = document.getElementById('answerInputs');
  area.innerHTML = '';
  if (attempt >= 1) q.type = 'text';
  if (q.type === 'text') {
    area.innerHTML = '<textarea id="answerText" class="w-full p-2 bg-gray-600 rounded"></textarea>';
  } else if (q.type === 'radio') {
    q.choices.forEach((c, i) => {
      const id = `r${i}`;
      area.innerHTML += `<label class="flex items-center gap-1"><input type="radio" name="choice" value="${c}" id="${id}">${c}</label>`;
    });
  } else if (q.type === 'checkbox') {
    q.choices.forEach((c, i) => {
      const id = `c${i}`;
      area.innerHTML += `<label class="flex items-center gap-1"><input type="checkbox" value="${c}" class="cb">${c}</label>`;
    });
  }
}

function onSend() {
  if (!currentTask) return;
  const q = JSON.parse(currentTask.q);
  const attempt = document.querySelectorAll('#chatLog .msg-student').length;
  let text = '';
  if (q.type === 'text' || attempt >= 1) {
    text = document.getElementById('answerText').value.trim();
  } else if (q.type === 'radio') {
    const sel = document.querySelector('input[name="choice"]:checked');
    text = sel ? sel.value : '';
  } else if (q.type === 'checkbox') {
    text = Array.from(document.querySelectorAll('.cb:checked')).map(x => x.value).join(',');
  }
  if (!text) {
    alert('回答を入力してください');
    return;
  }
  appendMsg('student', text);
  if (mode === 'submit') {
    google.script.run.withSuccessHandler(() => {
      xp += xpPerQuest;
      totalXp += xpPerQuest;
      if (xp >= level * 100) { level++; xp = 0; }
      updateXpBar();
      loadTasks();
    }).submitAnswer(teacherCode, studentId, currentTask.id, text, xpPerQuest, totalXp, level, '', aiCalls, attempt + 1);
  } else {
    if (aiCalls >= 2) {
      appendMsg('system', 'Geminiはこれ以上使えません。');
      return;
    }
    aiCalls++;
    google.script.run.withSuccessHandler(res => { appendMsg('gemini', res); })
      .callGeminiAPI_GAS(teacherCode, text, '小学生向け');
  }
  document.getElementById('answerInputs').querySelectorAll('input,textarea').forEach(e => e.value = '');
}

function appendMsg(type, text) {
  const log = document.getElementById('chatLog');
  const div = document.createElement('div');
  div.className = `msg-${type}`;
  div.innerHTML = `<p class="p-2 rounded ${type === 'student' ? 'bg-indigo-600 ml-auto' : 'bg-gray-700'} max-w-[80%]">${escapeHtml(text)}</p>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function escapeHtml(str) {
  return str == null ? '' : String(str).replace(/[&<>'"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[m]));
}

function loadXp() { updateXpBar(); }
function updateXpBar() {
  document.getElementById('playerLevel').textContent = level;
  document.getElementById('xpCurrent').textContent = xp;
  document.getElementById('xpNext').textContent = level * 100;
  const pct = Math.min((xp / (level * 100)) * 100, 100);
  gsap.to('#xpFill', { width: pct + '%', duration: 0.5 });
}

const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let particles = [];
const maxParticles = 80;
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();
class Particle {
  constructor() { this.reset(); }
  reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.vx = (Math.random() - 0.5) * 0.3; this.vy = (Math.random() - 0.5) * 0.3; this.size = Math.random() * 2 + 1; this.alpha = Math.random() * 0.5 + 0.3; }
  update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) { this.reset(); this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; } }
  draw() { ctx.beginPath(); ctx.fillStyle = `rgba(255,255,255,${this.alpha})`; ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
}
function initParticles() { particles = []; for (let i = 0; i < maxParticles; i++) { particles.push(new Particle()); } }
function animateParticles() { ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{ p.update(); p.draw(); }); requestAnimationFrame(animateParticles); }
</script>
<div id="versionInfo" class="fixed bottom-2 right-2 text-xs text-gray-400"><?!= version ?></div>
</body>
</html>

