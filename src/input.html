<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest â€“ ã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ¼ãƒ‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ã‚²ãƒ¼ãƒ ã£ã½ã„ãƒ‰ãƒƒãƒˆãƒ•ã‚©ãƒ³ãƒˆ -->
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet" />
  <!-- TailwindCSS + GSAP -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <!-- Lucide UMD for icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.259.0/dist/umd/lucide.min.js"></script>
  <style>
    body {
      font-family: 'DotGothic16', monospace;
    }
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
    #debugPanel {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      width: 320px;
      max-height: 200px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #4b5563;
      border-radius: 0.5rem;
      overflow-y: auto;
      padding: 0.75rem;
      font-size: 0.75rem;
      line-height: 1.2;
      color: #d1d5db;
      z-index: 50;
    }
    #debugPanelHeader {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #debugClose {
      cursor: pointer;
      color: #f87171;
    }
    /* å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é»’é€éèƒŒæ™¯ */
    #historyModal {
      background: rgba(0, 0, 0, 0.7);
    }
    /* ãƒ¢ãƒã‚¤ãƒ«æ™‚ã«ã‚«ãƒ©ãƒ ã‚’ç¸¦ä¸¦ã³ã« */
    @media (max-width: 768px) {
      #questMain {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100 flex flex-col items-center p-4 md:p-8">
  <!-- èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="particleCanvas"></canvas>

  <!-- XPãƒãƒ¼ï¼‹ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
  <div class="w-full max-w-3xl mx-auto mt-6 mb-4 px-4">
    <div class="flex justify-between items-center mb-1">
      <span class="text-sm">Level <span id="playerLevel">1</span></span>
      <span class="text-sm"><span id="xpCurrent">0</span> XP / <span id="xpNext">100</span> XP</span>
    </div>
    <div class="bg-gray-800 rounded-full overflow-hidden w-full h-2">
      <div id="xpFill" class="h-full bg-pink-400 w-0"></div>
    </div>
  </div>

  <main id="questMain" class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-5 gap-8">
    <!-- å·¦ã‚«ãƒ©ãƒ ï¼šæœªå›ç­”ãƒ»å›ç­”æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’ã¾ã¨ã‚ãŸã‚«ãƒ¼ãƒ‰ -->
    <div class="md:col-span-2 bg-gradient-to-br from-purple-800 to-indigo-700 rounded-2xl shadow-2xl flex flex-col p-4 space-y-6">
      <!-- æœªå›ç­”ã‚¯ã‚¨ã‚¹ãƒˆ -->
      <section>
        <h2 class="text-lg font-bold mb-2 flex items-center gap-2 text-white">
          <svg data-icon="Target" class="w-6 h-6 text-pink-400"></svg>
          æœªå›ç­”ã‚¯ã‚¨ã‚¹ãƒˆ
        </h2>
        <div id="unansweredList" class="bg-gray-800 p-4 rounded-lg min-h-[80px] space-y-2">
          <p class="text-gray-400 text-sm text-center">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
        </div>
      </section>

      <!-- å›ç­”æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆ -->
      <section>
        <h2 class="text-lg font-bold mb-2 flex items-center gap-2 text-white">
          <svg data-icon="CheckCircle" class="w-6 h-6 text-indigo-400"></svg>
          å®Œäº†æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆ
        </h2>
        <div id="answeredList" class="bg-gray-800 p-4 rounded-lg min-h-[80px] space-y-2">
          <p class="text-gray-400 text-sm text-center">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
        </div>
      </section>
    </div>

    <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ï¼†é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ -->
    <div class="md:col-span-3 bg-gray-800 p-6 rounded-2xl shadow-2xl flex flex-col">
      <h2 id="detailTitle" class="text-xl font-bold mb-4 text-center">ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°</h2>
      <div id="detailContent" class="flex-grow bg-gray-700 p-4 rounded-lg shadow-inner min-h-[200px]">
        <p class="text-gray-400 text-center">å·¦ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>
  </main>

  <!-- æå‡ºå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="fixed inset-0 hidden items-center justify-center">
    <div class="bg-gray-800 p-4 rounded-2xl max-w-lg w-full mx-4 shadow-2xl">
      <h3 class="text-lg font-bold mb-2 flex items-center gap-2 text-white">
        <svg data-icon="BookOpen" class="w-5 h-5 text-indigo-300"></svg>
        æå‡ºå±¥æ­´
      </h3>
      <div id="historyContent" class="max-h-64 overflow-y-auto space-y-2 px-2">
        <!-- å±¥æ­´ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
      </div>
      <button id="historyClose" class="mt-4 px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white text-sm rounded-lg shadow-md transition-transform hover:scale-105">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆå·¦ä¸‹ï¼‰ -->
  <div id="debugPanel">
    <div id="debugPanelHeader">
      <span>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</span>
      <span id="debugClose">âœ•</span>
    </div>
    <div id="debugContent"></div>
  </div>

  <!-- Apps Script ã‹ã‚‰åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•° -->
  <script>
    const teacherCode = "<?= teacher ?>";
    const grade       = "<?= grade ?>";
    const classroom   = "<?= classroom ?>";
    const number      = "<?= number ?>";
    const studentId   = `${grade}-${classroom}-${number}`;  // ä¾‹: "6-1-1"
  </script>

  <script>
    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Lucide Icons ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderIcons(scope) {
      scope.querySelectorAll('[data-icon]').forEach(el => {
        const iconName = el.getAttribute('data-icon');
        if (window.lucide && typeof window.lucide[iconName] === 'function') {
          el.innerHTML = window.lucide[iconName]().outerHTML;
        }
      });
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›ç”¨
    const debugContentElem = document.getElementById('debugContent');
    function debug(msg) {
      const t = new Date().toLocaleTimeString();
      debugContentElem.innerHTML += `<p>[${t}] ${msg}</p>`;
      debugContentElem.scrollTop = debugContentElem.scrollHeight;
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('debugClose').addEventListener('click', () => {
      document.getElementById('debugPanel').classList.add('hidden');
    });

    // XP / Level ã®çŠ¶æ…‹
    let xp = 0;
    let totalXp = 0;
    let level = 1;
    const xpPerQuest = 20;

    // ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ç³»ã®é…åˆ—
    let allUnanswered = [];
    let allAnswered   = [];
    let currentQuest  = null;

    document.addEventListener('DOMContentLoaded', () => {
      // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’èµ·å‹•
      initParticles();
      animateParticles();

      // Lucide Icons ã‚’æç”»
      renderIcons(document);

      debug('ğŸ”„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€‚');
      debug(`â–¶ teacherCode="${teacherCode}", grade="${grade}", class="${classroom}", number="${number}"`);
      debug(`â–¶ client ã§çµ„ã¿ç«‹ã¦ãŸ studentId="${studentId}"`);

      if (!teacherCode || !grade || !classroom || !number) {
        debug('âš ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³ â†’ å‡¦ç†ä¸­æ–­');
        alert('ç„¡åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      initStudentAndLoad();
    });

    // â”€â”€â”€ initStudent & ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ãƒ­ãƒ¼ãƒ‰ â”€â”€â”€
    function initStudentAndLoad() {
      debug('â¤ initStudent ã‚’å‘¼ã³å‡ºã—â†’ ç”Ÿå¾’ã‚·ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰');
      google.script.run
        .withSuccessHandler(res => {
          debug(`âœ… initStudent æˆåŠŸ â†’ è¿”ã‚Šå€¤: ${JSON.stringify(res)}`);
          loadQuestLists();
          loadXP();
        })
        .withFailureHandler(err => {
          debug(`âŒ initStudent ã‚¨ãƒ©ãƒ¼: ${err.message || JSON.stringify(err)}`);
          alert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        })
        .initStudent(teacherCode, grade, classroom, number);
    }

    // â”€â”€â”€ listTasks ï¼† getStudentHistory ï¼æç”» â”€â”€â”€
    function loadQuestLists() {
      debug('â¤ listTasks ã‚’å‘¼ã³å‡ºã—ä¸­â€¦');
      google.script.run
        .withSuccessHandler(tasks => {
          debug(`âœ… listTasks æˆåŠŸ â†’ tasks.length = ${Array.isArray(tasks) ? tasks.length : 'undefined'}`);
          debug(`   â†“ raw tasks =\n${JSON.stringify(tasks, null, 2)}`);
          tasks = Array.isArray(tasks) ? tasks : [];
          debug(`   â‡’ tasks IDãƒªã‚¹ãƒˆ: ${JSON.stringify(tasks.map(t => t.id))}`);

          debug('â¤ getStudentHistory ã‚’å‘¼ã³å‡ºã—ä¸­â€¦');
          google.script.run
            .withSuccessHandler(historyRows => {
              // null/undefined ãªã‚‰ç©ºé…åˆ—ã«ç½®ãæ›ãˆ
              if (!Array.isArray(historyRows)) {
                debug('   âš ï¸ getStudentHistory ãŒ null/undefined â†’ [] ã«ç½®ãæ›ãˆ');
                historyRows = [];
              }
              debug(`âœ… getStudentHistory æˆåŠŸ â†’ historyRows.length = ${historyRows.length}`);
              debug(`   â†“ raw historyRows =\n${JSON.stringify(historyRows, null, 2)}`);

              // å›ç­”æ¸ˆã¿ ID ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆå›ç­”æœ¬æ–‡ãŒç©ºã§ã¯ãªã„ã‚‚ã®ã®ã¿ï¼‰
              const answeredIds = new Set(
                historyRows
                  .map(r => {
                    const ans = r[3];
                    const txt = (ans == null ? '' : ans.toString().trim());
                    return txt === '' ? null : r[1];
                  })
                  .filter(v => v !== null)
              );
              debug(`   â†’ answeredIds = ${JSON.stringify(Array.from(answeredIds))}`);

              allUnanswered = tasks.filter(t => !answeredIds.has(t.id));
              allAnswered   = tasks.filter(t =>  answeredIds.has(t.id));
              debug(`   â†’ allUnanswered ä»¶æ•°=${allUnanswered.length}, IDs=${JSON.stringify(allUnanswered.map(q => q.id))}`);
              debug(`   â†’ allAnswered   ä»¶æ•°=${allAnswered.length}, IDs=${JSON.stringify(allAnswered.map(q => q.id))}`);

              renderQuestLists(allUnanswered, allAnswered, historyRows);
            })
            .withFailureHandler(errHist => {
              debug(`âŒ getStudentHistory ã‚¨ãƒ©ãƒ¼: ${errHist.message || JSON.stringify(errHist)}`);
              renderQuestLists(tasks, [], []);
            })
            .getStudentHistory(teacherCode, studentId);
        })
        .withFailureHandler(err => {
          debug(`âŒ listTasks ã‚¨ãƒ©ãƒ¼: ${err.message || JSON.stringify(err)}`);
          document.getElementById('unansweredList').innerHTML =
            '<p class="text-red-500 text-center">ã‚¯ã‚¨ã‚¹ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        })
        .listTasks(teacherCode);
    }

    // â”€â”€â”€ ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’æç”» â”€â”€â”€
    function renderQuestLists(allUnanswered, allAnswered, historyRows) {
      debug('âœ renderQuestLists é–‹å§‹');
      const ulUn = document.getElementById('unansweredList');
      const ulAn = document.getElementById('answeredList');
      ulUn.innerHTML = '';
      ulAn.innerHTML = '';

      // æœªå›ç­”
      if (!Array.isArray(allUnanswered) || allUnanswered.length === 0) {
        ulUn.innerHTML = '<p class="text-gray-400 text-sm text-center">æœªå›ç­”ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        debug('  [ç”»é¢ä¸Š] æœªå›ç­”ã‚¯ã‚¨ã‚¹ãƒˆãªã—è¡¨ç¤º');
      } else {
        allUnanswered.forEach(q => {
          let parsed;
          try {
            parsed = JSON.parse(q.q);
          } catch (e) {
            parsed = { subject: '(JSON è§£æå¤±æ•—)', question: q.q };
          }
          const item = document.createElement('div');
          item.className = 'bg-gray-700 p-3 rounded-md cursor-pointer hover:bg-gray-600';
          item.innerHTML = `
            <p class="text-sm mb-1 text-white">ã€${escapeHtml(parsed.subject || 'ç„¡é¡Œ')}ã€‘ ${escapeHtml(parsed.question || '(è³ªå•ãªã—)')}</p>
            <p class="text-xs text-gray-300">${escapeHtml(q.date)}</p>
          `;
          item.addEventListener('click', () => showQuestDetail(q, false, historyRows));
          ulUn.appendChild(item);
        });
        debug('  [ç”»é¢ä¸Š] æœªå›ç­”ã‚¯ã‚¨ã‚¹ãƒˆã‚’æç”»å®Œäº†');
      }

      // å›ç­”æ¸ˆã¿
      if (!Array.isArray(allAnswered) || allAnswered.length === 0) {
        ulAn.innerHTML = '<p class="text-gray-400 text-sm text-center">å›ç­”æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        debug('  [ç”»é¢ä¸Š] å›ç­”æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆãªã—è¡¨ç¤º');
      } else {
        allAnswered.forEach(q => {
          let parsed;
          try {
            parsed = JSON.parse(q.q);
          } catch (e) {
            parsed = { subject: '(JSON è§£æå¤±æ•—)', question: q.q };
          }
          const item = document.createElement('div');
          item.className = 'bg-gray-700 p-3 rounded-md cursor-pointer hover:bg-gray-600';
          item.innerHTML = `
            <p class="text-sm line-through opacity-70 text-gray-300">ã€${escapeHtml(parsed.subject || 'ç„¡é¡Œ')}ã€‘ ${escapeHtml(parsed.question || '(è³ªå•ãªã—)')}</p>
            <p class="text-xs text-gray-400">${escapeHtml(q.date)}</p>
          `;
          item.addEventListener('click', () => showQuestDetail(q, true, historyRows));
          ulAn.appendChild(item);
        });
        debug('  [ç”»é¢ä¸Š] å›ç­”æ¸ˆã¿ã‚¯ã‚¨ã‚¹ãƒˆã‚’æç”»å®Œäº†');
      }
    }

    // â”€â”€â”€ ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ã‚’è¡¨ç¤º & é€ä¿¡å‡¦ç† â”€â”€â”€
    function showQuestDetail(task, isAnswered, historyRows) {
      debug(`âœ showQuestDetail â†’ task.id=${task.id}, isAnswered=${isAnswered}`);
      currentQuest = task;
      let parsed;
      try {
        parsed = JSON.parse(task.q);
      } catch (e) {
        parsed = { subject: '(JSON è§£æå¤±æ•—)', question: task.q };
      }

      const detail = document.getElementById('detailContent');
      detail.innerHTML = `
        <h3 class="text-lg font-bold mb-2 text-white">ã€${escapeHtml(parsed.subject || 'ç„¡é¡Œ')}ã€‘ ${escapeHtml(parsed.question || '(è³ªå•ãªã—)')}</h3>
        <div id="formArea" class="mt-2">
          <textarea id="detailAnswer" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›â€¦" class="w-full p-2 bg-gray-600 rounded text-sm text-gray-100 placeholder-gray-400"></textarea>
          <div class="mt-2 flex gap-2">
            <button id="submitBtn" class="bg-pink-600 hover:bg-pink-500 text-white text-sm px-4 py-1 rounded shadow transition-transform hover:scale-105">é€ä¿¡</button>
            <button id="viewHistoryBtn" class="text-xs text-indigo-300 hover:underline">å±¥æ­´ã‚’è¦‹ã‚‹</button>
            <button id="aiBtn" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-2 rounded">AIãƒ’ãƒ³ãƒˆ</button>
          </div>
          <div id="aiArea" class="mt-2 text-sm text-indigo-300 whitespace-pre-wrap"></div>
        </div>
      `;
      debug('  [ç”»é¢ä¸Š] è©³ç´°ç”»é¢è¡¨ç¤ºå®Œäº†');

      // ç›´è¿‘ã®å›ç­”ãŒã‚ã‚Œã°ãƒ—ãƒªãƒ•ã‚£ãƒ«
      const userSubs = historyRows.filter(r => r[1] === task.id);
      debug(`  ã“ã®ã‚¿ã‚¹ã‚¯ã®å±¥æ­´ä»¶æ•°: ${userSubs.length}`);
      if (userSubs.length > 0) {
        const last = userSubs[userSubs.length - 1];
        document.getElementById('detailAnswer').value = last[3] || '';
        debug(`  [ç”»é¢ä¸Š] å‰å›å›ç­”ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«: "${last[3] || ''}"`);
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      document.getElementById('submitBtn').addEventListener('click', () => {
        const text = document.getElementById('detailAnswer').value.trim();
        submitAnswer(task.id, text);
      });
      debug('  [ç”»é¢ä¸Š] é€ä¿¡ãƒœã‚¿ãƒ³ã« click ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š');

      // å±¥æ­´è¡¨ç¤ºãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      document.getElementById('viewHistoryBtn').addEventListener('click', () => {
        showHistory(task.id, historyRows);
      });
      debug('  [ç”»é¢ä¸Š] å±¥æ­´è¡¨ç¤ºãƒœã‚¿ãƒ³ã« click ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š');

      document.getElementById('aiBtn').addEventListener('click', () => {
        const text = document.getElementById('detailAnswer').value.trim();
        google.script.run
          .withSuccessHandler(res => {
            document.getElementById('aiArea').textContent = res;
          })
          .withFailureHandler(err => {
            alert('AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—å¤±æ•—: ' + err.message);
          })
          .callGeminiAPI_GAS(`å›ç­”: ${text}`, 'å°å­¦ç”Ÿå‘ã‘');
      });
      debug('  [ç”»é¢ä¸Š] AIãƒœã‚¿ãƒ³ã« click ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š');
    }

    // â”€â”€â”€ å›ç­”ã‚’é€ä¿¡ï¼ˆè¤‡æ•°å›OKï¼‰ â”€â”€â”€
    function submitAnswer(taskId, text) {
      if (!text) {
        debug('âš ï¸ é€ä¿¡ã‚¨ãƒ©ãƒ¼: å›ç­”ãŒç©ºã§ã™');
        return;
      }
      debug(`â¤ submitAnswer â†’ taskId=${taskId}, text length=${text.length}`);
      google.script.run
        .withSuccessHandler(() => {
          debug('âœ… submitAnswer æˆåŠŸ â†’ XPã‚’åŠ ç®—');
          xp += xpPerQuest;
          totalXp += xpPerQuest;
          if (xp >= xpNextThreshold()) {
            level++;
            xp = xp - xpNextThreshold();
            debug(`ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«: ${level}`);
          }
          updateXPBar();

          debug('â€¦å°‘ã—é…å»¶å¾Œã«ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿');
          setTimeout(() => {
            loadQuestLists();
            debug('â¤ ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿å®Œäº†');
          }, 200);

          gsap.fromTo('#submitBtn', { scale: 1.1 }, { scale: 1, duration: 0.2 });
        })
        .withFailureHandler(err => {
          debug(`âŒ submitAnswer ã‚¨ãƒ©ãƒ¼: ${err.message || JSON.stringify(err)}`);
        })
        .submitAnswer(teacherCode, studentId, taskId, text, xpPerQuest, totalXp + xpPerQuest, level, '', 0, userSubs.length + 1);
    }

    // â”€â”€â”€ æå‡ºå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º â”€â”€â”€
    function showHistory(taskId, historyRows) {
      debug(`ğŸ“š showHistory â†’ taskId=${taskId}`);
      const rows = historyRows.filter(r => r[1] === taskId);
      debug(`  å¯¾è±¡å±¥æ­´ä»¶æ•° = ${rows.length}`);
      const container = document.getElementById('historyContent');
      container.innerHTML = '';

      if (rows.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center">æå‡ºå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        debug('  [ç”»é¢ä¸Š] æå‡ºå±¥æ­´ãªã—');
      } else {
        rows.forEach(r => {
          const div = document.createElement('div');
          div.className = 'bg-gray-700 p-2 rounded mb-1';
          div.innerHTML = `
            <p class="text-xs text-gray-400">${escapeHtml(new Date(r[0]).toLocaleString())}</p>
            <p class="text-sm text-gray-100">${escapeHtml(r[3])}</p>
          `;
          container.appendChild(div);
        });
        debug(`  [ç”»é¢ä¸Š] æå‡ºå±¥æ­´ ${rows.length} ä»¶ã‚’è¡¨ç¤º`);
      }
      document.getElementById('historyModal').classList.remove('hidden');
    }

    // â”€â”€â”€ å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ â”€â”€â”€
    document.getElementById('historyClose').addEventListener('click', () => {
      debug('âœ– å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
      document.getElementById('historyModal').classList.add('hidden');
    });

    // â”€â”€â”€ XP / Level æ›´æ–° â”€â”€â”€
    function loadXP() {
      updateXPBar();
      debug('â¤ XPãƒãƒ¼åˆæœŸåŒ–å®Œäº†');
    }
    function xpNextThreshold() {
      return level * 100;
    }
    function updateXPBar() {
      document.getElementById('playerLevel').textContent = level;
      document.getElementById('xpCurrent').textContent = xp;
      document.getElementById('xpNext').textContent = xpNextThreshold();
      const pct = Math.min((xp / xpNextThreshold()) * 100, 100);
      gsap.to('#xpFill', { width: pct + '%', duration: 0.5 });
      debug(`  XPãƒãƒ¼æ›´æ–°: ${xp}/${xpNextThreshold()} (${Math.round(pct)}%)`);
    }

    // â”€â”€â”€ èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆè»½é‡å®Ÿè£…ï¼‰ â”€â”€â”€
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const maxParticles = 80;
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.3;
        this.vy = (Math.random() - 0.5) * 0.3;
        this.size = Math.random() * 2 + 1;
        this.alpha = Math.random() * 0.5 + 0.3;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        if (
          this.x < 0 || this.x > canvas.width ||
          this.y < 0 || this.y > canvas.height
        ) {
          this.reset();
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
        }
      }
      draw() {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    function initParticles() {
      particles = [];
      for (let i = 0; i < maxParticles; i++) {
        particles.push(new Particle());
      }
    }
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      requestAnimationFrame(animateParticles);
    }
  </script>
</body>
</html>
