<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest – チャット</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.395.0/dist/lucide.min.js"></script>
  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      background-color: #1a1b26;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #2a2f4a; }
    ::-webkit-scrollbar-thumb { background: #4a4f8a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #5a5f9a; }

    /* Background pattern */
    .pixel-bg {
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 16px 16px;
    }

    /* Glass style panels */
    .glass-panel {
      background: rgba(26, 27, 38, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Game-like button */
    .game-btn { transition: all 0.2s ease; border-bottom-width: 4px; }
    .game-btn:active { transform: translateY(2px); border-bottom-width: 2px; }
  </style>
</head>
<body class="text-gray-200 min-h-screen p-4 pixel-bg">

  <div class="max-w-7xl mx-auto h-[calc(100vh-2rem)] flex flex-col gap-4">
    <header class="glass-panel rounded-xl p-3 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-lg">
      <div class="flex items-center gap-3">
        <i data-lucide="swords" class="w-8 h-8 text-cyan-400"></i>
        <h1 class="text-2xl font-bold tracking-wider text-white">StudyQuest</h1>
      </div>
      <div class="w-full sm:w-1/2 lg:w-1/3">
        <div class="flex justify-between items-center mb-1 text-sm text-gray-400">
          <span>Lv. <span id="playerLevel">1</span></span>
          <span><span id="studentId"></span></span>
        </div>
        <div class="h-4 bg-gray-900/50 rounded-full border border-gray-600 overflow-hidden">
          <div id="xpFill" class="h-full bg-gradient-to-r from-pink-500 to-yellow-500 w-0" style="transition: width 0.5s ease-in-out;"></div>
        </div>
        <div class="text-center text-xs mt-1 text-yellow-300">
          <span id="xpCurrent">0</span> / <span id="xpNext">100</span> XP
        </div>
      </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
      <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col glass-panel rounded-xl p-4 shadow-lg">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 border-b-2 border-gray-600 pb-2">
          <i data-lucide="scroll-text" class="w-6 h-6 text-amber-400"></i>
          クエストボード
        </h2>
        <div class="space-y-3 overflow-y-auto flex-grow">
          <div>
            <h3 class="text-sm font-bold text-pink-400 mb-2">未回答クエスト</h3>
            <div id="unanswered" class="space-y-2"></div>
          </div>
          <div>
            <h3 class="text-sm font-bold text-cyan-400 mb-2">完了済みクエスト</h3>
            <div id="answered" class="space-y-2"></div>
          </div>
        </div>
      </aside>

      <section class="w-full md:w-2/3 lg:w-3/4 flex flex-col glass-panel rounded-xl shadow-lg overflow-hidden">
        <div id="chatLog" class="flex-1 p-4 space-y-4 overflow-y-auto"></div>
        <div id="inputArea" class="bg-gray-900/70 p-4 border-t-2 border-gray-700">
          <div id="answerInputs" class="mb-3"></div>
          <div class="flex flex-col sm:flex-row items-center gap-3">
            <button id="sendBtn" class="game-btn w-full sm:w-auto flex-grow bg-pink-600 text-white px-8 py-2 rounded-lg font-bold border-pink-800 hover:bg-pink-500 active:border-pink-700 flex items-center justify-center gap-2">
              <i data-lucide="send-horizontal"></i>
              <span>提出する</span>
            </button>
            <button id="modeToggle" class="game-btn w-full sm:w-auto bg-gray-600 text-gray-200 px-6 py-2 rounded-lg font-bold border-gray-800 hover:bg-gray-500 active:border-gray-700 flex items-center justify-center gap-2">
              <i data-lucide="sparkles"></i>
              <span>Geminiにヒントを求める</span>
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>
<script>
const SCRIPT_URL = '<?!= scriptUrl.replace("/dev","/exec") ?>';
const teacherCode = '<?!= teacher ?>';
const grade = '<?!= grade ?>';
const classroom = '<?!= classroom ?>';
const number = '<?!= number ?>';
const version = '<?!= version ?>';
const studentId = `${grade}-${classroom}-${number}`;
let xp = 0;
let level = 1;
let totalXp = 0;
const xpPerQuest = 10;
let currentTask = null;
let mode = 'submit';
let aiCalls = 0;

function debug(msg) { console.log(msg); }

function renderIcons(scope) {
  if (window.lucide) {
    window.lucide.createIcons({ nameAttr: 'data-icon', icons: window.lucide.icons });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  renderIcons(document);
  if (!teacherCode || !grade || !classroom || !number) {
    alert('不正なアクセス');
    return;
  }
  initStudent();
  document.getElementById('modeToggle').addEventListener('click', toggleMode);
  document.getElementById('sendBtn').addEventListener('click', onSend);
});

function toggleMode() {
  mode = mode === 'submit' ? 'gemini' : 'submit';
  const btn = document.getElementById('sendBtn');
  btn.textContent = mode === 'submit' ? '提出' : 'ヒント';
  document.getElementById('modeToggle').textContent = mode === 'submit' ? 'Gemini' : '提出';
}

function initStudent() {
  google.script.run.withSuccessHandler(() => { loadTasks(); loadXp(); })
    .withFailureHandler(e => alert('初期化失敗: ' + e.message))
    .initStudent(teacherCode, grade, classroom, number);
}

function loadTasks() {
  google.script.run.withSuccessHandler(tasks => {
    google.script.run.withSuccessHandler(history => {
      history = Array.isArray(history) ? history : [];
      renderLists(tasks || [], history);
    }).getStudentHistory(teacherCode, studentId);
  }).listTasks(teacherCode);
}

function renderLists(tasks, history) {
  const answeredIds = new Set(history.filter(r => (r[3] || '').toString().trim() !== '').map(r => r[1]));
  const unanswered = tasks.filter(t => !answeredIds.has(t.id));
  const answered = tasks.filter(t => answeredIds.has(t.id));
  const unEl = document.getElementById('unanswered');
  const anEl = document.getElementById('answered');
  unEl.innerHTML = '';
  anEl.innerHTML = '';
  unanswered.forEach(t => {
    const div = document.createElement('div');
    const q = JSON.parse(t.q);
    div.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600';
    div.textContent = `【${q.subject}】 ${q.question}`;
    div.addEventListener('click', () => openTask(t, history));
    unEl.appendChild(div);
  });
  answered.forEach(t => {
    const div = document.createElement('div');
    const q = JSON.parse(t.q);
    div.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 opacity-70 line-through';
    div.textContent = `【${q.subject}】 ${q.question}`;
    div.addEventListener('click', () => openTask(t, history));
    anEl.appendChild(div);
  });
  if (!currentTask && unanswered.length) openTask(unanswered[0], history);
}

function openTask(task, history) {
  currentTask = task;
  aiCalls = 0;
  const q = JSON.parse(task.q);
  const log = document.getElementById('chatLog');
  log.innerHTML = '';
  appendMsg('system', `【${q.subject}】 ${q.question}`);
  const rows = history.filter(r => r[1] === task.id);
  rows.forEach(r => appendMsg('student', r[3]));
  renderInput(q, rows.length);
  log.scrollTop = log.scrollHeight;
}

function renderInput(q, attempt) {
  const area = document.getElementById('answerInputs');
  area.innerHTML = '';
  if (attempt >= 1) q.type = 'text';
  if (q.type === 'text') {
    area.innerHTML = '<textarea id="answerText" class="w-full p-2 bg-gray-600 rounded"></textarea>';
  } else if (q.type === 'radio') {
    q.choices.forEach((c, i) => {
      const id = `r${i}`;
      area.innerHTML += `<label class="flex items-center gap-1"><input type="radio" name="choice" value="${c}" id="${id}">${c}</label>`;
    });
  } else if (q.type === 'checkbox') {
    q.choices.forEach((c, i) => {
      const id = `c${i}`;
      area.innerHTML += `<label class="flex items-center gap-1"><input type="checkbox" value="${c}" class="cb">${c}</label>`;
    });
  }
}

function onSend() {
  if (!currentTask) return;
  const q = JSON.parse(currentTask.q);
  const attempt = document.querySelectorAll('#chatLog .msg-student').length;
  let text = '';
  if (q.type === 'text' || attempt >= 1) {
    text = document.getElementById('answerText').value.trim();
  } else if (q.type === 'radio') {
    const sel = document.querySelector('input[name="choice"]:checked');
    text = sel ? sel.value : '';
  } else if (q.type === 'checkbox') {
    text = Array.from(document.querySelectorAll('.cb:checked')).map(x => x.value).join(',');
  }
  if (!text) {
    alert('回答を入力してください');
    return;
  }
  appendMsg('student', text);
  if (mode === 'submit') {
    google.script.run.withSuccessHandler(() => {
      xp += xpPerQuest;
      totalXp += xpPerQuest;
      if (xp >= level * 100) { level++; xp = 0; }
      updateXpBar();
      loadTasks();
    }).submitAnswer(teacherCode, studentId, currentTask.id, text, xpPerQuest, totalXp, level, '', aiCalls, attempt + 1);
  } else {
    if (aiCalls >= 2) {
      appendMsg('system', 'Geminiはこれ以上使えません。');
      return;
    }
    aiCalls++;
    google.script.run.withSuccessHandler(res => { appendMsg('gemini', res); })
      .callGeminiAPI_GAS(teacherCode, text, '小学生向け');
  }
  document.getElementById('answerInputs').querySelectorAll('input,textarea').forEach(e => e.value = '');
}

function appendMsg(type, text) {
  const log = document.getElementById('chatLog');
  const div = document.createElement('div');
  div.className = `msg-${type}`;
  div.innerHTML = `<p class="p-2 rounded ${type === 'student' ? 'bg-indigo-600 ml-auto' : 'bg-gray-700'} max-w-[80%]">${escapeHtml(text)}</p>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function escapeHtml(str) {
  return str == null ? '' : String(str).replace(/[&<>'"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[m]));
}

function loadXp() { updateXpBar(); }
function updateXpBar() {
  document.getElementById('playerLevel').textContent = level;
  document.getElementById('xpCurrent').textContent = xp;
  document.getElementById('xpNext').textContent = level * 100;
  const pct = Math.min((xp / (level * 100)) * 100, 100);
  gsap.to('#xpFill', { width: pct + '%', duration: 0.5 });
}
</script>
<div id="versionInfo" class="fixed bottom-2 right-2 text-xs text-gray-400"><?!= version ?></div>
</body>
</html>

