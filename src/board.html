<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>StudyQuest - 回答ボード</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.395.0/dist/lucide.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      background-color: #1a1b26;
    }
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    .glass-panel {
      background: rgba(26, 27, 38, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .game-btn {
      transition: all 0.2s ease;
      border-bottom-width: 4px;
    }
    .game-btn:active {
      transform: translateY(2px);
      border-bottom-width: 2px;
    }
    /* デバッグパネル */
    #debugPanel {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      width: 320px;
      max-height: 200px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #4b5563;
      border-radius: 0.5rem;
      overflow-y: auto;
      padding: 0.75rem;
      font-size: 0.75rem;
      line-height: 1.2;
      color: #d1d5db;
      z-index: 50;
    }
    #debugPanelHeader {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #debugClose {
      cursor: pointer;
      color: #f87171;
    }
  </style>
</head>
<body class="text-gray-200 p-4 md:p-6">

  <canvas id="particleCanvas"></canvas>

  <div class="max-w-7xl mx-auto">
    <header class="glass-panel rounded-xl p-4 mb-4 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-lg">
      <div class="flex-grow w-full">
        <div class="bg-gray-900/50 p-3 rounded-lg border-l-4 border-cyan-400">
          <div class="flex justify-between items-center mb-1">
            <p class="text-sm text-gray-400 flex items-center gap-2">
              <i data-lucide="scroll-text" class="w-5 h-5"></i>
              <span id="headingLabel">現在のクエスト</span>
            </p>
            <p class="text-sm text-gray-400" id="answerCount"></p>
          </div>
          <p id="questionText" class="font-bold text-white mt-1"></p>
        </div>
      </div>
      <a href="#" id="backLink" class="game-btn bg-gray-600 text-gray-200 px-4 py-2 rounded-lg font-bold border-gray-800 hover:bg-gray-700 text-sm flex items-center gap-2 flex-shrink-0"></a>
      <a id="manageBtn" class="game-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold border-indigo-800 hover:bg-indigo-500 text-sm flex items-center gap-2 flex-shrink-0" href="#">
        <i data-lucide="settings" class="w-4 h-4"></i>
        <span>管理パネル</span>
      </a>
      <button type="button" id="closeTaskBtn" class="game-btn bg-red-600 text-white px-4 py-2 rounded-lg font-bold border-red-800 hover:bg-red-500 text-sm flex items-center gap-2 flex-shrink-0 hidden">
        <i data-lucide="square-x" class="w-4 h-4"></i>
        <span>クエストを閉じる</span>
      </button>
    </header>

    <section id="aiFollowupSection" class="glass-panel rounded-xl p-4 mb-4 shadow-lg hidden space-y-2">
      <label class="text-sm text-gray-400">回答テキスト</label>
      <textarea id="selectedAnswerInput" class="w-full p-2 bg-gray-900/80 rounded-md border border-gray-600 text-sm"></textarea>
      <div class="flex items-center gap-2">
        <button type="button" id="generateFollowupFromAnswerBtn" class="game-btn bg-purple-600 text-white px-4 py-2 rounded-lg font-bold border-purple-800 hover:bg-purple-500 text-sm flex-shrink-0">深掘り質問生成</button>
        <button type="button" id="toggleAnswerHistoryBtn" class="text-xs text-gray-400 hover:text-white ml-auto">生成履歴を見る ▼</button>
      </div>
      <div id="followupFromAnswerOutput" class="text-sm text-gray-300 bg-gray-900/50 p-2 rounded-md min-h-[40px] whitespace-pre-wrap"></div>
      <div id="answerHistoryWrapper" class="hidden">
        <div id="answerGenerationHistory" class="hidden mt-2 p-2 bg-gray-900/50 rounded-md space-y-2"></div>
      </div>
    </section>

    <main id="answers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></main>
  </div>

  <script>
  <?!= include('shared/escapeHtml'); ?>
  const SCRIPT_URL = '<?!= scriptUrl.replace("/dev","/exec") ?>';
  const teacherParam = '<?!= teacher ?>';
  const gradeParam = '<?!= grade ?>';
  const classParam = '<?!= classroom ?>';
  const numberParam = '<?!= number ?>';

    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const maxParticles = 80;
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.3;
        this.vy = (Math.random() - 0.5) * 0.3;
        this.size = Math.random() * 2 + 1;
        this.alpha = Math.random() * 0.5 + 0.3;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
          this.reset();
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
        }
      }
      draw() {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      for (let i = 0; i < maxParticles; i++) particles.push(new Particle());
    }
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(animateParticles);
    }
    initParticles();
    animateParticles();

    // デバッグログ出力用
    let debugContentElem;
    function debug(msg) {
      if (!debugContentElem) return;
      const t = new Date().toLocaleTimeString();
      debugContentElem.innerHTML += `<p>[${t}] ${msg}</p>`;
      debugContentElem.scrollTop = debugContentElem.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', () => {
      debugContentElem = document.getElementById('debugContent');
      const debugPanel = document.getElementById('debugPanel');
      debugPanel.classList.remove('hidden');

      const params = new URLSearchParams(location.search);
      let teacherCode = params.get('teacher') || teacherParam;
      let taskId = params.get('task');
      let persona = '';

      debug('🔄 ページ読み込み完了');
      debug(`▶ teacherCode="${teacherCode}", taskId="${taskId || ''}"`);

      if (!teacherCode) {
        alert('不正なアクセスです。');
        location.href = '?page=login';
        return;
      }
      const backLink = document.getElementById('backLink');
      const manageBtn = document.getElementById('manageBtn');
      const closeBtn = document.getElementById('closeTaskBtn');
      const grade = params.get('grade') || gradeParam;
      const classroom = params.get('class') || classParam;
      const number = params.get('number') || numberParam;
      const followupSection = document.getElementById('aiFollowupSection');

      const isStudent = grade && classroom && number;

      if (isStudent) {
        if (followupSection) followupSection.classList.add('hidden');
        backLink.href = `${SCRIPT_URL}?page=quest&teacher=${encodeURIComponent(teacherCode)}&grade=${encodeURIComponent(grade)}&class=${encodeURIComponent(classroom)}&number=${encodeURIComponent(number)}`;
        backLink.innerHTML = '<i data-lucide="arrow-left" class="w-4 h-4"></i><span>クエスト画面に戻る</span>';
        manageBtn.style.display = 'none';
      } else {
        if (followupSection) {
          followupSection.classList.remove('hidden');
          google.script.run.withSuccessHandler(p => { persona = p || ''; }).getGeminiPersona(teacherCode);
        }
        backLink.href = `${SCRIPT_URL}?page=manage&teacher=${encodeURIComponent(teacherCode)}`;
        backLink.innerHTML = '<i data-lucide="arrow-left" class="w-4 h-4"></i><span>管理パネルに戻る</span>';
        manageBtn.href = `${SCRIPT_URL}?page=manage&teacher=${encodeURIComponent(teacherCode)}`;
        manageBtn.style.display = '';
      }

      if (taskId) {
        if (closeBtn) closeBtn.classList.remove('hidden');
        document.getElementById('headingLabel').textContent = '課題別ボード';
        google.script.run.withSuccessHandler(tasks => {
          const t = tasks.find(x => x.id === taskId);
          let txt = '';
          if (t) {
            try {
              const q = JSON.parse(t.q);
              txt = `【${q.subject || ''}】 ${q.question}`;
            } catch (_) {
              txt = t.q;
            }
          }
          document.getElementById('questionText').textContent = txt;
          lucide.createIcons();
          loadBoard();
        }).listTasks(teacherCode);
      } else {
        google.script.run.withSuccessHandler(id => {
          taskId = id || null;
          if (taskId) {
            if (closeBtn) closeBtn.classList.remove('hidden');
            document.getElementById('headingLabel').textContent = '課題別ボード';
            google.script.run.withSuccessHandler(tasks => {
              const t = tasks.find(x => x.id === taskId);
              let txt = '';
              if (t) {
                try {
                  const q = JSON.parse(t.q);
                  txt = `【${q.subject || ''}】 ${q.question}`;
                } catch (_) {
                  txt = t.q;
                }
              }
              document.getElementById('questionText').textContent = txt;
              lucide.createIcons();
              loadBoard();
            }).listTasks(teacherCode);
          } else {
            document.getElementById('questionText').textContent = 'みんなの回答ボード';
            lucide.createIcons();
            loadBoard();
          }
        }).getLatestActiveTaskId(teacherCode);
      }

      function loadBoard() {
        const func = taskId ? 'listTaskBoard' : 'listBoard';
        google.script.run.withSuccessHandler(renderBoard)[func](teacherCode, taskId);
      }

      function renderBoard(rows) {
        const container = document.getElementById('answers');
        container.innerHTML = '';
        document.getElementById('answerCount').textContent = `提出: ${rows.length}件`;
        if (rows.length == 0) {
          container.innerHTML = '<p class="text-center text-gray-500">まだ提出されていません。</p>';
          return;
        }
        rows.forEach((r, i) => {
          const card = document.createElement('div');
          card.className = 'glass-panel rounded-xl p-4 flex flex-col gap-3 shadow-lg border-2 border-transparent hover:border-pink-500 transition-colors opacity-0';
          card.innerHTML = `
            <div class="flex items-center gap-2">
              <i data-lucide="user-circle" class="w-6 h-6 text-pink-400"></i>
              <p class="font-bold">${escapeHtml(r.studentId)}</p>
            </div>
            <div class="bg-gray-900/50 p-3 rounded-lg flex-grow">
              <p class="whitespace-pre-wrap break-words">${escapeHtml(r.answer)}</p>
            </div>
            <div class="text-xs space-y-1 text-gray-400">
              <div class="flex justify-between items-center"><span>ステータス:</span><span class="font-bold text-amber-300">Lv. ${r.level}</span></div>
              <div class="flex justify-between items-center"><span>獲得XP:</span><span class="font-bold text-green-400">+${r.earnedXp} XP</span></div>
            </div>
          `;
          card.addEventListener('click', () => {
            const ansIn = document.getElementById('selectedAnswerInput');
            if (ansIn && !followupSection.classList.contains('hidden')) {
              ansIn.value = r.answer;
            }
          });
          container.appendChild(card);
          gsap.to(card, {
            delay: i * 0.1,
            opacity: 1,
            rotationY: 0,
            duration: 0.6,
            from: { rotationY: 90 }
          });
        });
        lucide.createIcons();
      }

      const ansInput = document.getElementById('selectedAnswerInput');
      const followupBtn = document.getElementById('generateFollowupFromAnswerBtn');
      const followupOut = document.getElementById('followupFromAnswerOutput');
      const historyBtn = document.getElementById('toggleAnswerHistoryBtn');
      const historyDiv = document.getElementById('answerGenerationHistory');
      const historyWrapper = document.getElementById('answerHistoryWrapper');
      let followupHistory = [];

      function updateFollowupHistory() {
        if (!historyWrapper) return;
        if (followupHistory.length === 0) {
          historyWrapper.classList.add('hidden');
          return;
        }
        historyWrapper.classList.remove('hidden');
        historyDiv.innerHTML = '';
        followupHistory.forEach((txt, idx) => {
          const div = document.createElement('div');
          div.className = 'border-t border-gray-700 pt-2';
          div.innerHTML = `<p class="text-xs font-bold text-gray-500">履歴 ${idx + 1}</p><p class="text-xs whitespace-pre-wrap">${escapeHtml(txt)}</p>`;
          historyDiv.prepend(div);
        });
      }

      if (followupBtn) {
        followupBtn.addEventListener('click', () => {
          const ans = ansInput ? ansInput.value.trim() : '';
          if (!ans) return;
          followupOut.innerHTML = `AIが質問を生成中... <i data-lucide="loader-circle" class="inline-block animate-spin"></i>`;
          renderIcons(document);
          google.script.run
            .withSuccessHandler(res => {
              const lines = res.split(/\n|・/).map(s => s.trim()).filter(s => s);
              const text = lines.map(l => `・${l}`).join('\n');
              followupOut.textContent = text;
              followupHistory.push(text);
              updateFollowupHistory();
            })
            .withFailureHandler(err => {
              followupOut.textContent = '生成に失敗しました: ' + err.message;
            })
            .generateFollowupFromAnswer(ans, persona);
        });
      }

      if (historyBtn) {
        historyBtn.addEventListener('click', e => {
          const hidden = historyDiv.classList.toggle('hidden');
          e.target.textContent = hidden ? '生成履歴を見る ▼' : '生成履歴を隠す ▲';
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          if (!confirm('このクエストを閉じますか？')) return;
          google.script.run
            .withSuccessHandler(() => {
              closeBtn.disabled = true;
              closeBtn.textContent = '閉じました';
            })
            .withFailureHandler(err => alert('クエストを閉じられません: ' + err.message))
            .closeTask(teacherCode, taskId);
        });
      }

      if (!taskId) {
        // loadBoard will be called after resolving active task
      } else {
        loadBoard();
      }
      setInterval(loadBoard, 15000);
    });
  </script>

  <!-- デバッグパネル（左下） -->
  <div id="debugPanel">
    <div id="debugPanelHeader">
      <span>デバッグログ</span>
      <span id="debugClose">✕</span>
    </div>
    <div id="debugContent"></div>
  </div>

  <!-- バージョン表示 -->
  <div id="versionInfo" class="fixed bottom-2 right-2 text-xs text-gray-400"><?= version ?></div>
</body>
</html>
