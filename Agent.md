# AGENTS.md

このドキュメントは、StudyQuest プロジェクト内で OpenAI Codex（以下「Codex」）を AI エージェントとして活用し、開発・デプロイ・レビューの各フェーズを自動化・品質担保するための設計図です。人間開発者との役割分担、プロンプト管理、ワークフローインテグレーションのベストプラクティスを定めます。

---

## 1. プロジェクトの方向性

* **教育支援プラットフォーム**としての StudyQuest を、小学校教師と児童が使いやすい形で継続改善
* **GAS + GitHub Actions** による自動デプロイ／バージョン管理パイプラインを確立
* **Codex** をペアプログラマ／レビュアとして活用し、コード品質と一貫性を担保
* **反復的改善**：定期的（デイリー）にコードスタイルとテストカバレッジをチェックし、フィードバックを蓄積

---

## 2. エージェントと人間の役割分担

| 種別                 | 名称／担当              | 入力               | 出力                     | 担当領域                         |
| ------------------ | ------------------ | ---------------- | ---------------------- | ---------------------------- |
| **AI エージェント**      | **Codex Agent**    | プロンプト（.md）、既存コード | コードスニペット、テスト、YAML      | `src/`, `tests/`, `.github/` |
| **自動化フロー**         | **GitHub Actions** | リポジトリ変更トリガー      | デプロイ実行・バージョンバンプPR      | CI/CD パイプライン                 |
| **Human Reviewer** | 開発者                | Agent 出力PR       | レビューコメント、Approve/Merge | リポジトリ全体                      |

---

## 3. ディレクトリ構成とファイルルール

* `agents/prompts/`：タスクごとのプロンプトテンプレート（`*.md`）
* `codex.config.json`：Codex モデル設定（温度、トークン数上限など）
* `.github/workflows/`：自動デプロイ・CI 設定ファイル
* `src/`：Google Apps Script ソース（`.gs`）
* `tests/`：ユニットテスト（Jest 形式）

---

## 4. プロンプト管理

1. **テンプレート作成**：`agents/prompts/<task-name>.md` に以下を記載

   ```markdown
   ### Task: <タスク名>
   - **対象ファイル**: `src/...` or `tests/...`
   - **要件**: <具体的要件>
   - **出力形式**: <コードのみ、テスト含むなど>
   ```
2. **実行コマンド**：`npm run codex:gen -- <task-name>` で自動生成スクリプトを実行し、PR をオープン

---

## 5. 自動化ワークフロー

### 5.1 コード生成フロー

```yaml
# .github/workflows/codex-gen.yml
on:
  issue_comment:
    types: [created]
    # コメントに /gen-codex <task-name> が含まれるとトリガー
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
      - name: Run Codex Generation
        run: npm run codex:gen -- ${{ github.event.comment.body }}
      - name: Create PR
        uses: peter-evans/create-pull-request@v4
        with:
          branch: codex/$TASK_NAME
          title: "feat: generate code for $TASK_NAME"
          body: "Generated by Codex Agent"
```

### 5.2 デプロイ＆バージョンバンプフロー

```yaml
# .github/workflows/deploy-gas-webapp.yml
permissions:
  contents: write
on:
  push:
    branches: [main]
    paths: ['src/**']
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: persist-credentials: true
      - name: Deploy via clasp
        run: |
          set -eux
          npm ci
          npm run build
          clasp push --force
          NEW_VER=$(clasp version "auto-$(date +%Y%m%d%H%M%S)" | grep -oE '[0-9]+' | head -n1)
          clasp update-deployment "$DEPLOYMENT_ID" --versionNumber "$NEW_VER" --description "auto-deploy"
          echo "webapp_url=https://script.google.com/macros/s/$DEPLOYMENT_ID/exec?page=login" >> "$GITHUB_OUTPUT"
      - name: Bump version
        run: |
          npm version patch --no-git-tag-version
          git add package.json src/Code.gs tests/Code.test.js
          git commit -m "chore: bump version to v$(node -p "require('./package.json').version") [skip ci]"
          git push
```

---

## 6. 品質保証

* **Lint**: ESLint + clasp lint を必須実行
* **Test**: Jest テストを `npm test` で常時チェック
* **PR レビュー**: `agent-generated` ラベル付き PR は必ず 1 人以上の人間レビュアーが Approve してからマージ

---

## 7. 継続的改善

* **定期チェック**: 毎朝 9:00 に `npm run codex:lint` を実行し、スタイル逸脱を検知→Issue 化
* **フィードバック管理**: `agents/feedback/` にレビューフィードバックを Markdown で蓄積

---

*End of AGENTS.md*
