name: Deploy GAS as Web App

on:
  push:
    branches:
      - main

jobs:
  deploy-gas-webapp:
    name: Deploy GAS \u2192 overwrite existing Web App deployment
    runs-on: ubuntu-latest

    env:
      # 以下 2 つは GitHub リポジトリの Secrets に登録済み
      CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
      DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}

    steps:
      # 1) コードをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      # 2) Node.js をセットアップ（clasp の動作に必要）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3) clasp をインストール
      - name: Install clasp (latest)
        run: |
          npm install --global @google/clasp@latest

      # 4) CLASPRC_JSON を ~/.clasprc.json に書き出し
      - name: Configure ~/.clasprc.json for clasp authentication
        run: |
          mkdir -p ~/.config
          echo "${CLASPRC_JSON}" > ~/.clasprc.json
        # CLASPRC_JSON は Secrets から渡ってくる証言 JSON 全文

      # 5) push → 新バージョン作成 → 既存 deploymentId に上書きデプロイ（ウェブアプリ）
      - name: Push & Deploy as Web App
        run: |
          set -eux

          # 5-1) ソースを Apps Script に強制プッシュ
          clasp push --force

          # 5-2) 新しいバージョンを作成し、番号を変数に入れる
            NEW_VER=$(clasp version "auto-$(date +%Y%m%d%H%M%S)" | grep -oE "[0-9]+" | head -n1)
            if [ -z "$NEW_VER" ]; then
              echo "Failed to retrieve version number" >&2
              exit 1
            fi
            echo "→ 新しいバージョン番号: ${NEW_VER}"
          # 5-3) 既存の DEPLOYMENT_ID を使って上書きデプロイ
          #        かならず --webapp を付けることで Web アプリと\u3057\u3066更新\u3055\u308c\u308b
          clasp deploy \
            --deploymentId "${DEPLOYMENT_ID}" \
            --versionNumber "${NEW_VER}" \
            --description "auto-deploy from GitHub Actions" \
            --webapp

          # 5-4) 公開 URL を組み立て（?page=login を末尾に追加）
          FINAL_URL="https://script.google.com/macros/s/${DEPLOYMENT_ID}/exec?page=login"
          echo "\u2705 Web アプリ\u6700\u65b0\u7248\u306e URL: ${FINAL_URL}"
