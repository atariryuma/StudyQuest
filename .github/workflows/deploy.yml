name: Deploy GAS via clasp

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy GAS via clasp
    runs-on: ubuntu-latest

    env:
      # GitHub のリポジトリの Settings → Secrets で設定しておく
      SCRIPT_ID: ${{ secrets.SCRIPT_ID }}
      GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js (20.x)
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      - name: Install clasp v3
        run: npm install --global @google/clasp@3.0.6-alpha

      - name: Decode service account JSON & configure ADC
        run: |
          # Base64 化されたサービスアカウント JSON を復元
          echo "${GCP_CREDENTIALS}" | base64 -d > "${HOME}/gcp-sa.json"
          # 環境変数にセットして ADC を有効化
          echo "GOOGLE_APPLICATION_CREDENTIALS=${HOME}/gcp-sa.json" >> $GITHUB_ENV

      - name: Create .clasp.json
        run: |
          # .clasp.json に scriptId を書き出す
          echo "{\"scriptId\":\"${SCRIPT_ID}\"}" > .clasp.json

      - name: Push to Google Apps Script
        run: |
          # clasp を ADC モードで実行
          clasp push --force --adc
        # clasp コマンドは環境変数 GOOGLE_APPLICATION_CREDENTIALS を参照する
